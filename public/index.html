<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Asken Online</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg-dark: #1a1a2e;
      --bg-card: #25253d;
      --bg-felt: #2d5a4a;
      --bg-felt-dark: #1e3d32;
      --text: #f0f0f0;
      --text-dim: #888;
      --accent: #e6b84a;
      --red: #e05252;
      --green: #4caf50;
      --card-shadow: 0 4px 15px rgba(0,0,0,0.3);
      --glow: 0 0 20px rgba(230, 184, 74, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 8px;
    }

    h2 {
      font-size: 1.3rem;
      margin-bottom: 16px;
    }

    /* ============================================
       LOBBY / JOIN SK√ÑRMAR
       ============================================ */
    
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .menu-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      margin: 40px auto;
    }

    .menu-card h1 {
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: var(--text-dim);
    }

    .form-group input {
      width: 100%;
      padding: 14px;
      border: 2px solid #3a3a5a;
      border-radius: 10px;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input.code-input {
      text-transform: uppercase;
      letter-spacing: 8px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .btn-primary:hover {
      background: #d4a73e;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 2px solid #3a3a5a;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .divider {
      text-align: center;
      margin: 24px 0;
      color: var(--text-dim);
      font-size: 0.85rem;
    }

    .error-msg {
      background: rgba(224, 82, 82, 0.15);
      border: 1px solid var(--red);
      color: var(--red);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    /* ============================================
       LOBBY (v√§ntar p√• spelare)
       ============================================ */

    .lobby-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      margin: 40px auto;
      text-align: center;
    }

    .room-code {
      font-size: 3rem;
      font-weight: bold;
      letter-spacing: 12px;
      color: var(--accent);
      margin: 24px 0;
      font-family: monospace;
    }

    .room-code-label {
      font-size: 0.9rem;
      color: var(--text-dim);
    }

    .player-list {
      margin: 24px 0;
      text-align: left;
    }

    .player-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-dark);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .player-list-item.is-me {
      border: 2px solid var(--accent);
    }

    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .player-info {
      flex: 1;
    }

    .player-info .name {
      font-weight: 600;
    }

    .player-info .role {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .host-badge {
      background: var(--accent);
      color: var(--bg-dark);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .waiting-text {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    .mode-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 16px;
      background: var(--bg-dark);
      border: 2px solid #3a3a5a;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .mode-btn.active {
      border-color: var(--accent);
      background: rgba(230, 184, 74, 0.1);
    }

    .mode-btn span {
      display: block;
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 4px;
    }

    /* ============================================
       SPELSK√ÑRM
       ============================================ */

    .game-screen {
      padding-bottom: 20px;
    }

    .tableau-container {
      background: linear-gradient(145deg, var(--bg-felt), var(--bg-felt-dark));
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 
        inset 0 2px 10px rgba(0,0,0,0.3),
        0 4px 20px rgba(0,0,0,0.4);
    }

    .tableau-title {
      text-align: center;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .tableau {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 16px;
    }

    .suit-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      min-width: 75px;
      flex-shrink: 0;
    }

    .card-stack-upper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      height: 90px;
      justify-content: flex-end;
      flex-shrink: 0;
      overflow: hidden;
    }

    .card-stack-seven {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 76px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .card-stack-lower {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      height: 90px;
      justify-content: flex-start;
      flex-shrink: 0;
      overflow: hidden;
    }

    .table-card {
      width: 52px;
      height: 72px;
      background: white;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .table-card.red { color: var(--red); }
    .table-card.black { color: #222; }

    .table-card .rank { font-size: 1.1rem; }
    .table-card .suit { font-size: 1.3rem; }

    .table-card.seven {
      background: linear-gradient(135deg, #fff9e6, #fff);
      box-shadow: 0 2px 12px rgba(230, 184, 74, 0.4);
    }

    .table-card.completed {
      background: linear-gradient(135deg, #e0e0e0, #c8c8c8);
      opacity: 0.7;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .table-card.completed.red { color: #a06060; }
    .table-card.completed.black { color: #606060; }

    .card-placeholder {
      width: 52px;
      height: 72px;
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.4);
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* ============================================
       SPELARE
       ============================================ */

    .players-area {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .player-section {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 16px 20px;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .player-section.current-player {
      border-color: var(--accent);
      box-shadow: var(--glow);
    }

    .player-section.is-me {
      background: linear-gradient(135deg, var(--bg-card), #2a2a4a);
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .player-name {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: var(--accent);
      color: var(--bg-dark);
      border-radius: 4px;
      font-weight: 600;
    }

    .dealer-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: rgba(255,255,255,0.15);
      color: var(--text);
      border-radius: 4px;
      font-weight: 500;
    }

    .winner-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: linear-gradient(135deg, #ffd700, #ffb700);
      color: var(--bg-dark);
      border-radius: 4px;
      font-weight: 600;
      animation: winner-glow 1s ease-in-out infinite alternate;
    }

    @keyframes winner-glow {
      from { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
      to { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
    }

    .asken-icon {
      font-size: 1rem;
    }

    .player-stats {
      display: flex;
      gap: 16px;
      color: var(--text-dim);
      font-size: 0.85rem;
    }

    .player-hand-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .player-hand {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      min-height: 90px;
      align-items: flex-start;
      flex: 1;
    }

    .card {
      width: 56px;
      height: 78px;
      background: white;
      border-radius: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease-out, border-color 0.15s, box-shadow 0.15s;
      box-shadow: var(--card-shadow);
      user-select: none;
      position: relative;
      border: 2px solid transparent;
      -webkit-transform: translateY(0);
      transform: translateY(0);
      will-change: transform;
      -webkit-tap-highlight-color: transparent;
    }

    .card.red { color: var(--red); }
    .card.black { color: #222; }

    @media (hover: hover) {
      .card:hover:not(.disabled):not(.selected) {
        -webkit-transform: translateY(-10px);
        transform: translateY(-10px);
      }
    }

    .card.selected {
      -webkit-transform: translateY(-14px) !important;
      transform: translateY(-14px) !important;
      border-color: var(--accent);
      box-shadow: 0 8px 25px rgba(230, 184, 74, 0.5);
    }

    .card:not(.selected) {
      -webkit-transform: translateY(0);
      transform: translateY(0);
    }

    .card.playable {
      background: linear-gradient(135deg, #fffef5, #fff);
      cursor: pointer;
    }

    .card.playable::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border: 2px solid var(--green);
      border-radius: 9px;
      opacity: 0.6;
      animation: playable-pulse 2s infinite;
    }

    @keyframes playable-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .card.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .card .card-rank {
      font-size: 1.15rem;
      line-height: 1;
    }

    .card .card-suit {
      font-size: 1.4rem;
      line-height: 1;
    }

    /* Kort-baksida (andras kort) */
    .card-back {
      width: 32px;
      height: 46px;
      background: linear-gradient(135deg, #3a5a8a, #2a4a6a);
      border-radius: 4px;
      border: 1px solid #4a6a9a;
      box-shadow: 1px 0 2px rgba(0,0,0,0.3);
      flex-shrink: 0;
    }

    .hidden-hand {
      display: flex;
      flex-wrap: wrap;
      min-height: 50px;
      padding-left: 8px;
    }

    .hidden-hand .card-back {
      margin-left: -8px;
    }

    .select-all-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .select-all-btn:hover {
      background: var(--accent);
      color: var(--bg-dark);
      transform: scale(1.1);
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn.play {
      background: var(--green);
      color: white;
    }

    .action-btn.play:hover:not(:disabled) {
      background: #5cbf60;
    }

    .action-btn.pass {
      background: var(--red);
      color: white;
    }

    .action-btn.pass:hover:not(:disabled) {
      background: #e86565;
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ============================================
       MODAL
       ============================================ */

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    .modal h2 {
      margin-bottom: 8px;
    }

    .winner {
      font-size: 1.3rem;
      color: var(--accent);
      margin-bottom: 24px;
    }

    .score-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .score-table th,
    .score-table td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #3a3a5a;
    }

    .score-table th {
      color: var(--text-dim);
      font-weight: 500;
      font-size: 0.8rem;
    }

    .score-table td:first-child {
      text-align: left;
    }

    .score-table .total {
      font-weight: 600;
      color: var(--accent);
    }

    .score-table .asken-cell {
      color: var(--red);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    .modal-btn {
      padding: 14px 36px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn:hover {
      background: #d4a73e;
      transform: translateY(-2px);
    }

    .modal-btn.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.7);
    }

    .modal-btn.secondary:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .modal-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
      margin-top: 16px;
    }

    .not-host-msg {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    /* Footer */
    .game-footer {
      display: flex;
      justify-content: center;
      margin-top: 24px;
    }

    .quit-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .quit-btn:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    /* ============================================
       RESPONSIV
       ============================================ */

    @media (max-width: 600px) {
      .tableau {
        gap: 8px;
      }

      .suit-column {
        padding: 8px;
        min-width: 55px;
      }

      .card-stack-upper,
      .card-stack-lower {
        height: 62px;
      }

      .card-stack-seven {
        height: 58px;
      }

      .table-card,
      .card-placeholder {
        width: 38px;
        height: 54px;
      }

      .table-card .rank { font-size: 0.85rem; }
      .table-card .suit { font-size: 0.95rem; }

      .card {
        width: 44px;
        height: 62px;
      }

      .card-back {
        width: 26px;
        height: 38px;
      }

      .hidden-hand .card-back {
        margin-left: -6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Meny-sk√§rm -->
    <div class="screen active" id="menuScreen">
      <div class="menu-card">
        <h1>üÉè ASKEN</h1>
        <div id="menuError" class="error-msg" style="display: none;"></div>
        <div class="form-group">
          <label>Ditt namn</label>
          <input type="text" id="playerName" placeholder="Ange ditt namn" maxlength="20">
        </div>
        <button class="btn btn-primary" onclick="createRoom()">Skapa nytt rum</button>
        <div class="divider">eller</div>
        <div class="form-group">
          <label>Rumskod</label>
          <input type="text" id="roomCode" class="code-input" placeholder="XXXX" maxlength="4">
        </div>
        <button class="btn btn-secondary" onclick="joinRoom()">G√• med i rum</button>
      </div>
    </div>

    <!-- Lobby-sk√§rm -->
    <div class="screen" id="lobbyScreen">
      <div class="lobby-card">
        <h2>V√§ntar p√• spelare...</h2>
        <div class="room-code-label">Rumskod</div>
        <div class="room-code" id="displayRoomCode">XXXX</div>
        <div class="player-list" id="lobbyPlayerList"></div>
        <div class="waiting-text" id="waitingText">Minst 3 spelare kr√§vs f√∂r att starta</div>
        
        <div id="hostControls" style="display: none;">
          <div class="mode-selector">
            <button class="mode-btn active" data-mode="quick" onclick="setMode('quick')">
              Snabb
              <span>En runda</span>
            </button>
            <button class="mode-btn" data-mode="standard" onclick="setMode('standard')">
              Standard
              <span>Till 500 po√§ng</span>
            </button>
          </div>
          <button class="btn btn-primary" id="startGameBtn" onclick="startGame()" disabled>
            Starta spel
          </button>
        </div>
        
        <button class="btn btn-secondary" onclick="leaveRoom()">L√§mna rum</button>
      </div>
    </div>

    <!-- Spel-sk√§rm -->
    <div class="screen" id="gameScreen">
      <div class="tableau-container">
        <div class="tableau-title" id="tableauTitle">RUNDA 1 ‚Ä¢ INGEN HAR ASKEN</div>
        <div class="tableau" id="tableau"></div>
      </div>

      <div class="players-area" id="playersArea"></div>

      <div class="game-footer">
        <button class="quit-btn" onclick="leaveRoom()">L√§mna spel</button>
      </div>
    </div>

    <!-- Resultat-modal -->
    <div class="modal-overlay" id="modal" onclick="handleModalClick(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <h2 id="modalTitle">Runda slut!</h2>
        <div class="winner" id="modalWinner"></div>
        <table class="score-table" id="scoreTable">
          <thead>
            <tr>
              <th>Spelare</th>
              <th>Kort</th>
              <th>Po√§ng</th>
              <th>Asken</th>
              <th>Totalt</th>
            </tr>
          </thead>
          <tbody id="scoreBody"></tbody>
        </table>
        <div class="modal-buttons" id="modalButtons"></div>
        <p class="modal-hint">Klicka utanf√∂r f√∂r att se spelplanen</p>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // KONSTANTER
    // ============================================

    const SUITS = ['spades', 'hearts', 'clubs', 'diamonds'];
    const SUIT_SYMBOLS = { spades: '‚ô†', hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£' };
    const SUIT_COLORS = { spades: 'black', hearts: 'red', diamonds: 'red', clubs: 'black' };
    const RANK_NAMES = { 
      1: 'A', 2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 
      8: '8', 9: '9', 10: '10', 11: 'J', 12: 'Q', 13: 'K' 
    };

    // ============================================
    // STATE
    // ============================================

    let socket = null;
    let gameState = null;
    let selectedCardIds = [];
    let selectedMode = 'quick';

    // ============================================
    // SOCKET ANSLUTNING
    // ============================================

    function connectSocket() {
      socket = io();

      socket.on('connect', () => {
        console.log('Ansluten till server');
      });

      socket.on('roomCreated', ({ code }) => {
        document.getElementById('displayRoomCode').textContent = code;
        showScreen('lobbyScreen');
      });

      socket.on('roomJoined', ({ code }) => {
        document.getElementById('displayRoomCode').textContent = code;
        showScreen('lobbyScreen');
      });

      socket.on('gameState', (state) => {
        gameState = state;
        selectedCardIds = []; // Rensa valda kort vid ny state
        render();
      });

      socket.on('cardsSelected', (cardIds) => {
        selectedCardIds = cardIds;
        render();
      });

      socket.on('error', ({ message }) => {
        showError(message);
      });

      socket.on('disconnect', () => {
        console.log('Fr√•nkopplad fr√•n server');
        showScreen('menuScreen');
        showError('Anslutningen br√∂ts');
      });
    }

    // ============================================
    // SK√ÑRM-HANTERING
    // ============================================

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function showError(message) {
      const errorEl = document.getElementById('menuError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 4000);
    }

    // ============================================
    // MENY-FUNKTIONER
    // ============================================

    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) {
        showError('Ange ditt namn');
        return;
      }
      if (!socket) connectSocket();
      socket.emit('createRoom', name);
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const code = document.getElementById('roomCode').value.trim().toUpperCase();
      
      if (!name) {
        showError('Ange ditt namn');
        return;
      }
      if (!code || code.length !== 4) {
        showError('Ange en giltig rumskod (4 tecken)');
        return;
      }
      
      if (!socket) connectSocket();
      socket.emit('joinRoom', { code, name });
    }

    function leaveRoom() {
      if (socket) {
        socket.emit('leaveRoom');
      }
      gameState = null;
      selectedCardIds = [];
      showScreen('menuScreen');
    }

    function setMode(mode) {
      selectedMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
    }

    function startGame() {
      socket.emit('startGame', selectedMode);
    }

    // ============================================
    // SPELLOGIK
    // ============================================

    function toggleCard(cardId) {
      if (!gameState || gameState.roundEnded) return;
      
      const me = gameState.players.find(p => p.isMe);
      if (!me || !me.isCurrent) return;
      
      // Kolla om kortet √§r spelbart
      if (!gameState.playableCardIds?.includes(cardId)) return;
      
      const index = selectedCardIds.indexOf(cardId);
      if (index >= 0) {
        selectedCardIds.splice(index, 1);
      } else {
        selectedCardIds.push(cardId);
      }
      
      render();
    }

    function selectAllPlayable() {
      if (!gameState || gameState.roundEnded) return;
      if (!gameState.playableCardIds) return;
      
      selectedCardIds = [...gameState.playableCardIds];
      render();
    }

    function playCards() {
      if (selectedCardIds.length === 0) return;
      socket.emit('playCards', selectedCardIds);
      selectedCardIds = [];
    }

    function pass() {
      socket.emit('pass');
    }

    function nextRound() {
      socket.emit('nextRound');
      document.getElementById('modal').classList.remove('visible');
    }

    function newGame() {
      socket.emit('newGame');
      document.getElementById('modal').classList.remove('visible');
    }

    function handleModalClick(event) {
      if (event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('visible');
      }
    }

    // ============================================
    // RENDERING
    // ============================================

    function render() {
      if (!gameState) return;

      if (gameState.state === 'lobby') {
        renderLobby();
        showScreen('lobbyScreen');
      } else {
        renderGame();
        showScreen('gameScreen');
        
        if (gameState.roundEnded) {
          setTimeout(() => showResultModal(), 500);
        }
      }
    }

    function renderLobby() {
      const list = document.getElementById('lobbyPlayerList');
      list.innerHTML = gameState.players.map(p => `
        <div class="player-list-item ${p.isMe ? 'is-me' : ''}">
          <div class="player-avatar">${p.name.charAt(0).toUpperCase()}</div>
          <div class="player-info">
            <div class="name">${p.name}${p.isMe ? ' (du)' : ''}</div>
            <div class="role">${p.isHost ? 'V√§rd' : 'Spelare'}</div>
          </div>
          ${p.isHost ? '<span class="host-badge">V√ÑRD</span>' : ''}
        </div>
      `).join('');

      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const canStart = gameState.players.length >= 3;
      
      document.getElementById('hostControls').style.display = isHost ? 'block' : 'none';
      document.getElementById('startGameBtn').disabled = !canStart;
      document.getElementById('waitingText').textContent = canStart 
        ? `${gameState.players.length} spelare redo`
        : `Minst 3 spelare kr√§vs (${gameState.players.length}/3)`;
    }

    function renderGame() {
      renderTableau();
      renderPlayers();
      renderInfo();
    }

    function renderTableau() {
      const container = document.getElementById('tableau');
      container.innerHTML = '';

      for (const suit of SUITS) {
        const suitState = gameState.tableau[suit];
        const colorClass = SUIT_COLORS[suit];
        
        const column = document.createElement('div');
        column.className = 'suit-column';

        // √ñvre delen
        const upperStack = document.createElement('div');
        upperStack.className = 'card-stack-upper';

        if (suitState && suitState.high > 7) {
          const highCard = document.createElement('div');
          const isKing = suitState.high === 13;
          highCard.className = `table-card ${colorClass}${isKing ? ' completed' : ''}`;
          highCard.innerHTML = `
            <span class="rank">${RANK_NAMES[suitState.high]}</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          upperStack.appendChild(highCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = suitState ? '8' : '';
          placeholder.style.visibility = suitState ? 'visible' : 'hidden';
          upperStack.appendChild(placeholder);
        }

        column.appendChild(upperStack);

        // Mitten (7:an)
        const sevenStack = document.createElement('div');
        sevenStack.className = 'card-stack-seven';

        if (suitState) {
          const sevenCard = document.createElement('div');
          sevenCard.className = `table-card ${colorClass} seven`;
          sevenCard.innerHTML = `
            <span class="rank">7</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          sevenStack.appendChild(sevenCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = '7';
          sevenStack.appendChild(placeholder);
        }

        column.appendChild(sevenStack);

        // Nedre delen
        const lowerStack = document.createElement('div');
        lowerStack.className = 'card-stack-lower';

        if (suitState && suitState.low < 7) {
          const lowCard = document.createElement('div');
          const isAce = suitState.low === 1;
          lowCard.className = `table-card ${colorClass}${isAce ? ' completed' : ''}`;
          lowCard.innerHTML = `
            <span class="rank">${RANK_NAMES[suitState.low]}</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          lowerStack.appendChild(lowCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = suitState ? '6' : '';
          placeholder.style.visibility = suitState ? 'visible' : 'hidden';
          lowerStack.appendChild(placeholder);
        }

        column.appendChild(lowerStack);
        container.appendChild(column);
      }
    }

    function renderPlayers() {
      const container = document.getElementById('playersArea');
      container.innerHTML = '';

      for (const player of gameState.players) {
        const section = document.createElement('div');
        section.className = `player-section ${player.isCurrent && !gameState.roundEnded ? 'current-player' : ''} ${player.isMe ? 'is-me' : ''} ${player.isWinner ? 'winner' : ''}`;

        const hasPlayable = gameState.playableCardIds?.length > 0;
        const canPass = player.isCurrent && player.isMe && !hasPlayable && !gameState.roundEnded;

        section.innerHTML = `
          <div class="player-header">
            <div class="player-name">
              ${player.name}${player.isMe ? ' (du)' : ''}
              ${player.isDealer ? '<span class="dealer-badge">üé¥ Gav</span>' : ''}
              ${player.isWinner ? '<span class="winner-badge">üèÜ Vinnare!</span>' : ''}
              ${player.isCurrent && !gameState.roundEnded ? '<span class="player-badge">Spelar</span>' : ''}
              ${player.hasAsken ? '<span class="asken-icon" title="Har asken">üì¶</span>' : ''}
            </div>
            <div class="player-stats">
              <span>${player.cardCount} kort</span>
              <span>‚Ä¢</span>
              <span>Po√§ng: ${player.score}</span>
            </div>
          </div>
          ${player.isMe && player.hand ? renderOwnHand(player) : renderHiddenHand(player.cardCount)}
          ${player.isMe && player.isCurrent && !gameState.roundEnded ? `
            <div class="action-buttons">
              <button class="action-btn play" onclick="playCards()" ${selectedCardIds.length === 0 ? 'disabled' : ''}>
                Spela ${selectedCardIds.length > 0 ? '(' + selectedCardIds.length + ' kort)' : ''}
              </button>
              <button class="action-btn pass" onclick="pass()" ${!canPass ? 'disabled' : ''}>
                Passa ${canPass ? '(ta asken)' : ''}
              </button>
            </div>
          ` : ''}
        `;

        container.appendChild(section);
      }
    }

    function renderOwnHand(player) {
      const hasPlayable = gameState.playableCardIds?.length > 0 && player.isCurrent && !gameState.roundEnded;
      
      return `
        <div class="player-hand-container">
          <div class="player-hand">
            ${player.hand.map(card => {
              const isPlayable = gameState.playableCardIds?.includes(card.id) && player.isCurrent && !gameState.roundEnded;
              const isSelected = selectedCardIds.includes(card.id);
              const colorClass = SUIT_COLORS[card.suit];
              return `
                <div class="card ${colorClass} ${isPlayable ? 'playable' : 'disabled'} ${isSelected ? 'selected' : ''}"
                     onclick="toggleCard('${card.id}')">
                  <span class="card-rank">${RANK_NAMES[card.rank]}</span>
                  <span class="card-suit">${SUIT_SYMBOLS[card.suit]}</span>
                </div>
              `;
            }).join('')}
          </div>
          ${hasPlayable ? `
            <button class="select-all-btn" onclick="selectAllPlayable()" title="V√§lj alla spelbara kort">
              üí°
            </button>
          ` : ''}
        </div>
      `;
    }

    function renderHiddenHand(count) {
      return `
        <div class="hidden-hand">
          ${Array(count).fill('<div class="card-back"></div>').join('')}
        </div>
      `;
    }

    function renderInfo() {
      let titleText = `RUNDA ${gameState.roundNumber}`;
      
      if (gameState.roundEnded && gameState.roundWinners.length > 0) {
        if (gameState.roundWinners.length === 1) {
          titleText += ` SLUT ‚Ä¢ üèÜ ${gameState.roundWinners[0].name.toUpperCase()} VANN!`;
        } else {
          const names = gameState.roundWinners.map(w => w.name.toUpperCase());
          let winnerText;
          if (names.length === 2) {
            winnerText = names[0] + ' OCH ' + names[1];
          } else {
            const last = names.pop();
            winnerText = names.join(', ') + ' OCH ' + last;
          }
          titleText += ` SLUT ‚Ä¢ üèÜ ${winnerText} DELAR VINSTEN!`;
        }
      } else if (gameState.askenHolderId) {
        const holder = gameState.players.find(p => p.id === gameState.askenHolderId);
        titleText += ` ‚Ä¢ ${holder?.name?.toUpperCase() || 'OK√ÑND'} HAR ASKEN`;
      } else {
        titleText += ' ‚Ä¢ INGEN HAR ASKEN';
      }
      
      document.getElementById('tableauTitle').textContent = titleText;
    }

    function showResultModal() {
      const isGameOver = gameState.isGameOver;
      
      document.getElementById('modalTitle').textContent = isGameOver ? 'Spelet slut!' : 'Runda slut!';
      
      // Visa vinnare
      const winners = gameState.roundWinners;
      if (winners.length === 1) {
        const winText = isGameOver ? 'vinner spelet!' : 'vinner rundan!';
        document.getElementById('modalWinner').textContent = `üèÜ ${winners[0].name} ${winText}`;
      } else {
        const names = winners.map(w => w.name);
        let winnerText;
        if (names.length === 2) {
          winnerText = names[0] + ' och ' + names[1];
        } else {
          const last = names.pop();
          winnerText = names.join(', ') + ' och ' + last;
        }
        document.getElementById('modalWinner').textContent = `üèÜ ${winnerText} delar p√• vinsten!`;
      }

      // Po√§ngtabell
      const tbody = document.getElementById('scoreBody');
      tbody.innerHTML = gameState.players.map(p => `
        <tr>
          <td>${p.name}${p.isMe ? ' (du)' : ''}</td>
          <td>${p.cardCount}</td>
          <td>${p.cardCount > 0 ? '?' : '0'}</td>
          <td class="${p.hasAsken ? 'asken-cell' : ''}">${p.hasAsken ? '+50' : '‚Äî'}</td>
          <td class="total">${p.score}</td>
        </tr>
      `).join('');

      // Knappar
      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const buttonsHtml = isHost ? `
        <button class="modal-btn" onclick="${isGameOver ? 'newGame()' : 'nextRound()'}">
          ${isGameOver ? 'Nytt spel' : 'N√§sta runda'}
        </button>
        <button class="modal-btn secondary" onclick="leaveRoom()">Avsluta</button>
      ` : `
        <p class="not-host-msg">V√§ntar p√• att v√§rden ska forts√§tta...</p>
      `;
      document.getElementById('modalButtons').innerHTML = buttonsHtml;

      document.getElementById('modal').classList.add('visible');
    }

    // ============================================
    // INIT
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      connectSocket();
      
      // Enter-tangent f√∂r att g√• med
      document.getElementById('roomCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') joinRoom();
      });
      document.getElementById('playerName').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const code = document.getElementById('roomCode').value.trim();
          if (code.length === 4) {
            joinRoom();
          } else {
            createRoom();
          }
        }
      });
    });
  </script>
</body>
</html>
