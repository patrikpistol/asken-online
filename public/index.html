<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Asken Online</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg-dark: #1a1a1a;
      --bg-card: #2a2a2a;
      --bg-felt: #2d5a4a;
      --bg-felt-dark: #1e3d32;
      --text: #f0f0f0;
      --text-dim: #888;
      --accent: #c69e60;
      --accent-hover: #b08a50;
      --gold: #c69e60;
      --red: #e05252;
      --green: #4caf50;
      --card-shadow: 0 4px 15px rgba(0,0,0,0.3);
      --glow: 0 0 20px rgba(198, 158, 96, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark) url('gfx/bg_wood.webp') repeat;
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 8px;
    }

    h2 {
      font-size: 1.3rem;
      margin-bottom: 16px;
    }

    /* ============================================
       LOBBY / JOIN SKÄRMAR
       ============================================ */
    
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .menu-card {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      margin: 40px auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .menu-card h1 {
      margin-bottom: 24px;
    }
    
    .game-logo {
      max-width: 200px;
      height: auto;
      display: block;
      margin: 0 auto 24px auto;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: var(--text-dim);
    }

    .form-group input {
      width: 100%;
      padding: 14px;
      border: 2px solid #404040;
      border-radius: 10px;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      height: 50px;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input.code-input {
      text-transform: uppercase;
      letter-spacing: 4px;
      text-align: center;
      font-size: 1rem;
      font-weight: bold;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 2px solid #404040;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .rules-link {
      display: inline;
      color: var(--text-dim);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }
    
    .rules-link:hover {
      color: var(--accent);
    }
    
    .footer-links {
      text-align: center;
      margin-top: 16px;
    }

    .divider {
      text-align: center;
      margin: 24px 0;
      color: var(--text-dim);
      font-size: 0.85rem;
    }

    .error-msg {
      background: rgba(224, 82, 82, 0.15);
      border: 1px solid var(--red);
      color: var(--red);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    .error-msg.game-error {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 14px 28px;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid var(--red);
      color: #ff6b6b;
      font-weight: 600;
      animation: shake 0.5s ease-in-out;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(-50%); }
      20%, 60% { transform: translateX(calc(-50% - 10px)); }
      40%, 80% { transform: translateX(calc(-50% + 10px)); }
    }

    /* ============================================
       LOBBY (väntar på spelare)
       ============================================ */

    .lobby-card {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      margin: 40px auto;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .room-code-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .room-code {
      font-size: 3rem;
      font-weight: bold;
      letter-spacing: 12px;
      color: var(--accent);
      margin: 24px 0;
      font-family: monospace;
    }
    
    .copy-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .copy-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .copy-btn.copied {
      background: rgba(76, 175, 80, 0.3);
      border-color: #4caf50;
    }
    
    .invite-btn {
      background: transparent;
      border: 1px solid #505050;
      border-radius: 6px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      padding: 8px 20px;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .invite-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .invite-btn.copied {
      border-color: var(--green);
      color: var(--green);
    }
    
    .lobby-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .room-code-label {
      font-size: 0.9rem;
      color: var(--text-dim);
    }

    .player-list {
      margin: 24px 0;
      text-align: left;
    }

    .player-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-dark);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .player-list-item.is-me {
      border: 2px solid var(--accent);
    }

    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .player-info {
      flex: 1;
    }

    .player-info .name {
      font-weight: 600;
    }

    .player-info .role {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .host-badge {
      background: var(--accent);
      color: var(--bg-dark);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .player-list-item.is-bot {
      border: 1px dashed rgba(255, 255, 255, 0.3);
    }
    
    .player-list-item.is-bot .player-avatar {
      background: #6c5ce7;
      font-size: 1.3rem;
    }
    
    .remove-bot-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: rgba(224, 82, 82, 0.2);
      color: var(--red);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .remove-bot-btn:hover {
      background: rgba(224, 82, 82, 0.4);
    }
    
    .add-bot-btn {
      margin-bottom: 16px;
    }

    .waiting-text {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    .mode-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 16px;
      background: var(--bg-dark);
      border: 2px solid #404040;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .mode-btn.active {
      border-color: var(--accent);
      background: rgba(198, 158, 96, 0.1);
    }

    .mode-btn span {
      display: block;
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 4px;
    }
    
    .start-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .start-btn {
      flex: 1;
      padding: 16px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .start-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }
    
    .start-btn:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
    }
    
    .start-btn span {
      display: block;
      font-size: 0.8rem;
      font-weight: 400;
      opacity: 0.8;
      margin-top: 4px;
    }
    
    .difficulty-label {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 10px;
    }
    
    .difficulty-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .difficulty-btn {
      flex: 1;
      padding: 10px 12px;
      background: var(--bg-dark);
      border: 2px solid #404040;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 0.9rem;
    }
    
    .difficulty-btn.active {
      border-color: var(--accent);
      background: rgba(198, 158, 96, 0.1);
    }
    
    .difficulty-btn:hover:not(.active) {
      border-color: #606060;
    }
    
    /* Help Mode Toggle */
    .help-mode-toggle {
      margin: 16px 0;
      text-align: center;
    }
    
    .toggle-label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      gap: 12px;
    }
    
    .toggle-label input {
      display: none;
    }
    
    .toggle-slider {
      width: 48px;
      height: 26px;
      background: #404040;
      border-radius: 13px;
      position: relative;
      transition: background 0.3s;
    }
    
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--text);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.3s;
    }
    
    .toggle-label input:checked + .toggle-slider {
      background: var(--accent);
    }
    
    .toggle-label input:checked + .toggle-slider::before {
      transform: translateX(22px);
    }
    
    .toggle-text {
      font-size: 0.95rem;
      color: var(--text);
    }
    
    .help-mode-desc {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 6px;
    }
    
    /* Invalid Move Modal */
    .invalid-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .invalid-modal.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .invalid-modal-content {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 28px;
      max-width: 350px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    
    .invalid-modal-title {
      font-size: 1.4rem;
      color: var(--red);
      margin-bottom: 16px;
      font-weight: 600;
    }
    
    .invalid-modal-message {
      color: var(--text);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .invalid-modal-btn {
      padding: 12px 32px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .invalid-modal-btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }
    
    .invalid-modal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ============================================
       SPELSKÄRM
       ============================================ */

    .game-screen {
      padding-bottom: 20px;
    }

    .tableau-container {
      background: var(--bg-felt) url('gfx/bg_tyg.webp') repeat;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 
        inset 0 2px 10px rgba(0,0,0,0.3),
        0 8px 32px rgba(0,0,0,0.4);
    }

    .tableau-title {
      text-align: center;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .tableau {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 16px;
    }

    .suit-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      min-width: 75px;
      flex-shrink: 0;
    }

    .card-stack-upper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      height: 90px;
      justify-content: flex-end;
      flex-shrink: 0;
      overflow: hidden;
    }

    .card-stack-seven {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 76px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .card-stack-lower {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      height: 90px;
      justify-content: flex-start;
      flex-shrink: 0;
      overflow: hidden;
    }

    .table-card {
      width: 52px;
      height: 72px;
      background: white;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .table-card.red { color: var(--red); }
    .table-card.black { color: #222; }

    .table-card .rank { font-size: 1.1rem; }
    .table-card .suit { font-size: 1.3rem; }

    .table-card.seven {
      background: linear-gradient(135deg, #fff9e6, #fff);
      box-shadow: 0 2px 12px rgba(198, 158, 96, 0.4);
    }

    .table-card.completed {
      background: linear-gradient(135deg, #e0e0e0, #c8c8c8);
      opacity: 0.7;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .table-card.completed.red { color: #a06060; }
    .table-card.completed.black { color: #606060; }
    
    .table-card.last-played {
      box-shadow: 
        0 0 0 4px #ffd700,
        0 0 15px 5px rgba(255, 215, 0, 0.6),
        0 0 30px 10px rgba(255, 215, 0, 0.3);
      transform: scale(1.1);
      z-index: 10;
      animation: lastPlayedPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes lastPlayedPulse {
      0%, 100% {
        box-shadow: 
          0 0 0 4px #ffd700,
          0 0 15px 5px rgba(255, 215, 0, 0.6),
          0 0 30px 10px rgba(255, 215, 0, 0.3);
      }
      50% {
        box-shadow: 
          0 0 0 4px #ffd700,
          0 0 20px 8px rgba(255, 215, 0, 0.8),
          0 0 40px 15px rgba(255, 215, 0, 0.4);
      }
    }

    .card-placeholder {
      width: 52px;
      height: 72px;
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.4);
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* ============================================
       SPELARE
       ============================================ */

    .players-area {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .player-section {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 14px;
      padding: 16px 20px;
      transition: all 0.3s;
      border: 2px solid transparent;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .player-section.current-player {
      border-color: var(--accent);
      box-shadow: var(--glow), 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .player-section.is-me {
      background: linear-gradient(135deg, rgba(50, 50, 50, 0.8), rgba(50, 50, 50, 0.9)), url('gfx/bg_dark_steel.webp') repeat;
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .player-name {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: var(--accent);
      color: var(--bg-dark);
      border-radius: 4px;
      font-weight: 600;
    }

    .dealer-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: rgba(255,255,255,0.15);
      color: var(--text);
      border-radius: 4px;
      font-weight: 500;
    }
    
    .starter-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: rgba(0, 0, 0, 0.4);
      color: #aaa;
      border-radius: 4px;
      font-weight: 500;
    }

    .winner-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: linear-gradient(135deg, #ffd700, #ffb700);
      color: var(--bg-dark);
      border-radius: 4px;
      font-weight: 600;
      animation: winner-glow 1s ease-in-out infinite alternate;
    }

    @keyframes winner-glow {
      from { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
      to { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
    }

    .asken-icon {
      font-size: 1rem;
    }

    .player-stats {
      display: flex;
      gap: 16px;
      color: var(--text-dim);
      font-size: 0.85rem;
    }

    .player-hand-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .player-hand {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      min-height: 90px;
      align-items: flex-start;
      flex: 1;
    }

    .card {
      width: 56px;
      height: 78px;
      background: white;
      border-radius: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease-out, border-color 0.15s, box-shadow 0.15s;
      box-shadow: var(--card-shadow);
      user-select: none;
      position: relative;
      border: 2px solid transparent;
      -webkit-transform: translateY(0);
      transform: translateY(0);
      will-change: transform;
      -webkit-tap-highlight-color: transparent;
    }

    .card.red { color: var(--red); }
    .card.black { color: #222; }

    @media (hover: hover) {
      .card:hover:not(.disabled):not(.selected) {
        -webkit-transform: translateY(-10px);
        transform: translateY(-10px);
      }
    }

    .card.selected {
      -webkit-transform: translateY(-14px) !important;
      transform: translateY(-14px) !important;
      border-color: var(--accent);
      box-shadow: 0 8px 25px rgba(198, 158, 96, 0.5);
    }

    .card:not(.selected) {
      -webkit-transform: translateY(0);
      transform: translateY(0);
    }

    .card.playable {
      background: linear-gradient(135deg, #fffef5, #fff);
      cursor: pointer;
    }

    .card.playable::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border: 2px solid var(--green);
      border-radius: 9px;
      opacity: 0.6;
      animation: playable-pulse 2s infinite;
    }

    @keyframes playable-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .card.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .card .card-rank {
      font-size: 1.15rem;
      line-height: 1;
    }

    .card .card-suit {
      font-size: 1.4rem;
      line-height: 1;
    }

    /* Kort-baksida (andras kort) */
    .card-back {
      width: 32px;
      height: 46px;
      background: linear-gradient(135deg, #606060, #4a4a4a);
      border-radius: 4px;
      border: 1px solid #707070;
      box-shadow: 1px 0 2px rgba(0,0,0,0.3);
      flex-shrink: 0;
    }

    .hidden-hand {
      display: flex;
      flex-wrap: wrap;
      min-height: 50px;
      padding-left: 8px;
    }

    .hidden-hand .card-back {
      margin-left: -8px;
    }

    .select-all-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .select-all-btn:hover {
      background: var(--accent);
      color: var(--bg-dark);
      transform: scale(1.1);
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn.play {
      background: var(--green);
      color: white;
    }

    .action-btn.play:hover:not(:disabled) {
      background: #5cbf60;
    }

    .action-btn.pass {
      background: var(--red);
      color: white;
    }

    .action-btn.pass:hover:not(:disabled) {
      background: #e86565;
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ============================================
       MODAL
       ============================================ */

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    }

    .modal h2 {
      margin-bottom: 8px;
    }

    .winner {
      font-size: 1.3rem;
      color: var(--accent);
      margin-bottom: 24px;
    }

    .score-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .score-table th,
    .score-table td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #404040;
    }

    .score-table th {
      color: var(--text-dim);
      font-weight: 500;
      font-size: 0.8rem;
    }

    .score-table td:first-child {
      text-align: left;
    }

    .score-table .total {
      font-weight: 600;
      color: var(--accent);
    }

    .score-table .asken-cell {
      color: var(--red);
    }
    
    .score-table .place-cell {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .score-table .winner-row {
      background: rgba(198, 158, 96, 0.15);
    }
    
    .score-table .winner-row td {
      border-bottom-color: var(--gold);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    .modal-btn {
      padding: 14px 36px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .modal-btn.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.7);
    }

    .modal-btn.secondary:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .modal-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
      margin-top: 16px;
    }
    
    .invite-link-label {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 8px;
      text-align: left;
    }
    
    .invite-link-box {
      background: var(--bg-dark);
      border: 2px solid #404040;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.85rem;
      word-break: break-all;
      text-align: left;
      color: var(--accent);
      margin-bottom: 16px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    .invite-link-box:hover {
      border-color: var(--accent);
    }
    
    .invite-link-box.copied {
      border-color: var(--green);
      background: rgba(76, 175, 80, 0.1);
    }

    .not-host-msg {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    /* Footer */
    .game-footer {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 24px;
    }

    .quit-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .quit-btn:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    /* ============================================
       RESPONSIV
       ============================================ */

    @media (max-width: 600px) {
      .tableau {
        gap: 8px;
      }

      .suit-column {
        padding: 8px;
        min-width: 55px;
      }

      .card-stack-upper,
      .card-stack-lower {
        height: 62px;
      }

      .card-stack-seven {
        height: 58px;
      }

      .table-card,
      .card-placeholder {
        width: 38px;
        height: 54px;
      }

      .table-card .rank { font-size: 0.85rem; }
      .table-card .suit { font-size: 0.95rem; }

      .card {
        width: 44px;
        height: 62px;
      }

      .card-back {
        width: 26px;
        height: 38px;
      }

      .hidden-hand .card-back {
        margin-left: -6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Meny-skärm -->
    <div class="screen active" id="menuScreen">
      <div class="menu-card">
        <img src="gfx/asken_logo.webp" alt="ASKEN" class="game-logo">
        <div id="menuError" class="error-msg" style="display: none;"></div>
        <div class="form-row">
          <div class="form-group">
            <label>Ditt namn</label>
            <input type="text" id="playerName" placeholder="Namn" maxlength="20">
          </div>
          <div class="form-group">
            <label>Rumskod</label>
            <input type="text" id="roomCode" class="code-input" placeholder="XXXX" maxlength="4" oninput="updateMainButton()">
          </div>
        </div>
        <button class="btn btn-primary" id="mainActionBtn" onclick="mainAction()">Skapa nytt rum</button>
        <div class="footer-links">
          <a href="manual.html" class="rules-link">Spelregler</a>
          <span class="rules-link" style="cursor: default; margin: 0 8px;">•</span>
          <a href="about.html" class="rules-link">Om projektet</a>
        </div>
      </div>
    </div>

    <!-- Lobby-skärm -->
    <div class="screen" id="lobbyScreen">
      <div class="lobby-card">
        <h2>Väntar på spelare...</h2>
        <div class="room-code-label">Rumskod</div>
        <div class="room-code-container">
          <div class="room-code" id="displayRoomCode">XXXX</div>
        </div>
        <div class="lobby-actions">
          <button class="invite-btn" onclick="showInviteModal()">Bjud in vän</button>
          <button class="invite-btn" id="copyCodeBtn" onclick="copyRoomCode()">Kopiera rumskod</button>
        </div>
        <div class="player-list" id="lobbyPlayerList"></div>
        <div id="botButtonContainer"></div>
        <div id="botDifficultyContainer" style="display: none;">
          <div class="difficulty-label">Robotarnas intelligens</div>
          <div class="difficulty-selector">
            <button class="difficulty-btn active" data-difficulty="dumb" onclick="setBotDifficulty('dumb')">
              Dum
            </button>
            <button class="difficulty-btn" data-difficulty="medium" onclick="setBotDifficulty('medium')">
              Medel
            </button>
            <button class="difficulty-btn" data-difficulty="smart" onclick="setBotDifficulty('smart')">
              Smart
            </button>
          </div>
        </div>
        <div id="helpModeContainer" style="display: none;">
          <div class="help-mode-toggle">
            <label class="toggle-label">
              <input type="checkbox" id="helpModeCheckbox" onchange="toggleHelpMode()">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Visa spelbar hjälp</span>
            </label>
            <div class="help-mode-desc" id="helpModeDesc">Av - Du måste tänka själv!</div>
          </div>
        </div>
        <div class="waiting-text" id="waitingText">Minst 3 spelare krävs för att starta</div>
        
        <div id="hostControls" style="display: none;">
          <div class="start-buttons">
            <button class="start-btn" id="startQuickBtn" onclick="startGame('quick')" disabled>
              Spela snabbspel
              <span>En runda</span>
            </button>
            <button class="start-btn" id="startStandardBtn" onclick="startGame('standard')" disabled>
              Spela standardspel
              <span>Till 500 poäng</span>
            </button>
          </div>
        </div>
        
        <button class="btn btn-secondary" onclick="leaveRoom()">Lämna rum</button>
      </div>
    </div>

    <!-- Spel-skärm -->
    <div class="screen" id="gameScreen">
      <div id="gameError" class="error-msg game-error" style="display: none;"></div>
      <div class="tableau-container">
        <div class="tableau-title" id="tableauTitle">RUNDA 1 • INGEN HAR ASKEN</div>
        <div class="tableau" id="tableau"></div>
      </div>

      <div class="players-area" id="playersArea"></div>

      <div class="game-footer" id="gameFooter">
        <button class="quit-btn" onclick="leaveRoom()">Lämna spel</button>
      </div>
    </div>

    <!-- Resultat-modal -->
    <div class="modal-overlay" id="modal" onclick="handleModalClick(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <h2 id="modalTitle">Runda slut!</h2>
        <div class="winner" id="modalWinner"></div>
        <table class="score-table" id="scoreTable">
          <thead>
            <tr>
              <th>Spelare</th>
              <th>Kort</th>
              <th>Poäng</th>
              <th>Asken</th>
              <th>Totalt</th>
            </tr>
          </thead>
          <tbody id="scoreBody"></tbody>
        </table>
        <div class="modal-buttons" id="modalButtons"></div>
        <p class="modal-hint">Klicka utanför för att se spelplanen</p>
      </div>
    </div>
    
    <!-- Inbjudningsmodal -->
    <div class="modal-overlay" id="inviteModal" onclick="closeInviteModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <h2>Bjud in vän</h2>
        <div class="form-group" style="text-align: left; margin-top: 16px;">
          <label>Vännens namn</label>
          <input type="text" id="inviteName" placeholder="Ange namn" maxlength="20">
        </div>
        <div id="inviteLinkContainer" style="display: none;">
          <div class="invite-link-label">Inbjudningslänk</div>
          <div class="invite-link-box" id="inviteLinkBox"></div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn" id="generateLinkBtn" onclick="generateInviteLink()">Skapa länk</button>
          <button class="modal-btn secondary" onclick="closeInviteModal()">Stäng</button>
        </div>
      </div>
    </div>
    
    <!-- Ogiltigt drag modal -->
    <div class="invalid-modal" id="invalidMoveModal">
      <div class="invalid-modal-content">
        <div class="invalid-modal-title">❌ Ogiltigt drag</div>
        <div class="invalid-modal-message" id="invalidMoveMessage"></div>
        <button class="invalid-modal-btn" id="invalidMoveBtn" onclick="closeInvalidModal()" disabled>OK</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // KONSTANTER
    // ============================================

    const SUITS = ['spades', 'hearts', 'clubs', 'diamonds'];
    const SUIT_SYMBOLS = { spades: '♠', hearts: '♥', diamonds: '♦', clubs: '♣' };
    const SUIT_COLORS = { spades: 'black', hearts: 'red', diamonds: 'red', clubs: 'black' };
    const RANK_NAMES = { 
      1: 'A', 2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 
      8: '8', 9: '9', 10: '10', 11: 'J', 12: 'Q', 13: 'K' 
    };

    // ============================================
    // STATE
    // ============================================

    let socket = null;
    let gameState = null;
    let selectedCardIds = [];
    
    // För reconnect - använd sessionStorage för att överleva siduppdatering
    let currentRoomCode = sessionStorage.getItem('asken_roomCode') || null;
    let currentPlayerName = sessionStorage.getItem('asken_playerName') || null;
    let keepaliveInterval = null;
    
    // Hjälpfunktioner för att spara/rensa session
    function saveSession(code, name) {
      currentRoomCode = code;
      currentPlayerName = name;
      if (code && name) {
        sessionStorage.setItem('asken_roomCode', code);
        sessionStorage.setItem('asken_playerName', name);
      }
    }
    
    function clearSession() {
      currentRoomCode = null;
      currentPlayerName = null;
      sessionStorage.removeItem('asken_roomCode');
      sessionStorage.removeItem('asken_playerName');
    }

    // ============================================
    // SOCKET ANSLUTNING
    // ============================================

    function connectSocket() {
      socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,  // Fortsätt försöka
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        timeout: 45000,
        forceNew: false,
        transports: ['websocket', 'polling']  // Prioritera websocket
      });

      socket.on('connect', () => {
        console.log('Ansluten till server, socket.id:', socket.id);
        hideError(); // Ta bort eventuellt felmeddelande
        
        // Försök återansluta till rum om vi var i ett
        if (currentRoomCode && currentPlayerName) {
          console.log('Försöker återansluta till rum:', currentRoomCode);
          socket.emit('rejoinRoom', { 
            code: currentRoomCode, 
            name: currentPlayerName 
          });
        }
        
        // Starta keepalive-ping var 20:e sekund
        if (keepaliveInterval) clearInterval(keepaliveInterval);
        keepaliveInterval = setInterval(() => {
          if (socket && socket.connected && currentRoomCode) {
            socket.emit('ping');
          }
        }, 20000);
      });

      socket.on('roomCreated', ({ code }) => {
        saveSession(code, document.getElementById('playerName').value.trim());
        document.getElementById('displayRoomCode').textContent = code;
        showScreen('lobbyScreen');
      });

      socket.on('roomJoined', ({ code }) => {
        saveSession(code, document.getElementById('playerName').value.trim());
        document.getElementById('displayRoomCode').textContent = code;
        showScreen('lobbyScreen');
      });
      
      socket.on('rejoinSuccess', ({ code }) => {
        saveSession(code, currentPlayerName);
        document.getElementById('displayRoomCode').textContent = code;
        console.log('Återansluten till rum:', code);
      });
      
      socket.on('rejoinFailed', ({ message }) => {
        console.log('Kunde inte återansluta:', message);
        clearSession();
        showScreen('menuScreen');
        showError('Rummet finns inte längre. Skapa ett nytt.');
      });

      socket.on('gameState', (state) => {
        gameState = state;
        saveSession(state.code, currentPlayerName);
        selectedCardIds = [];
        render();
      });

      socket.on('cardsSelected', (cardIds) => {
        selectedCardIds = cardIds;
        render();
      });

      socket.on('error', ({ message }) => {
        showError(message);
      });
      
      // Ogiltigt drag (när hjälpläge är av)
      socket.on('invalidMove', ({ message }) => {
        showInvalidMoveModal(message);
      });
      
      // När spelet avbryts av en annan spelare
      socket.on('gameEnded', ({ playerName, reason }) => {
        document.getElementById('modal').classList.remove('visible');
        gameState = null;
        selectedCardIds = [];
        clearSession();
        showScreen('menuScreen');
        showError(`Spelet avslutades: ${playerName} har lämnat spelet`);
      });
      
      socket.on('hostEndedGame', () => {
        document.getElementById('modal').classList.remove('visible');
        gameState = null;
        selectedCardIds = [];
        clearSession();
        showScreen('menuScreen');
        showError('Värden har avslutat spelet');
      });
      
      // När värden startar nästa runda - stäng modal för alla
      socket.on('closeModal', () => {
        document.getElementById('modal').classList.remove('visible');
      });

      socket.on('disconnect', (reason) => {
        console.log('Frånkopplad från server:', reason);
        
        // Rensa keepalive
        if (keepaliveInterval) {
          clearInterval(keepaliveInterval);
          keepaliveInterval = null;
        }
        
        // Visa meddelande baserat på orsak
        if (reason === 'io server disconnect') {
          // Servern stängde anslutningen
          showError('Servern avslutade anslutningen - försöker återansluta...');
        } else if (reason === 'transport close' || reason === 'ping timeout') {
          showError('Tappad anslutning - försöker återansluta...');
        } else if (reason !== 'io client disconnect') {
          showError('Anslutningen avbröts - försöker återansluta...');
        }
      });
      
      socket.on('reconnect', (attemptNumber) => {
        console.log('Återansluten efter', attemptNumber, 'försök');
        hideError();
        
        // Socket.io har återanslutit, men vi behöver rejoin:a rummet
        // Detta hanteras automatiskt i 'connect'-eventet
      });
      
      socket.on('reconnect_attempt', (attemptNumber) => {
        if (attemptNumber > 3) {
          showError(`Återanslutningsförsök ${attemptNumber}...`);
        }
      });
      
      socket.on('reconnect_error', (error) => {
        console.log('Återanslutningsfel:', error.message);
      });
      
      socket.on('reconnect_failed', () => {
        // Behåll session så användaren kan ladda om och försöka igen
        showScreen('menuScreen');
        showError('Kunde inte återansluta till servern. Ladda om sidan och försök igen.');
      });
    }

    // ============================================
    // SKÄRM-HANTERING
    // ============================================

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function showError(message) {
      // Visa på spelskärmen om vi är där, annars på menyn
      const gameScreen = document.getElementById('gameScreen');
      const isInGame = gameScreen.classList.contains('active');
      
      const errorEl = document.getElementById(isInGame ? 'gameError' : 'menuError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      
      // Återställ animation
      errorEl.style.animation = 'none';
      errorEl.offsetHeight; // Trigger reflow
      errorEl.style.animation = null;
      
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 6000);
    }
    
    function hideError() {
      document.getElementById('gameError').style.display = 'none';
      document.getElementById('menuError').style.display = 'none';
    }

    // ============================================
    // MENY-FUNKTIONER
    // ============================================

    function updateMainButton() {
      const code = document.getElementById('roomCode').value.trim();
      const btn = document.getElementById('mainActionBtn');
      if (code.length > 0) {
        btn.textContent = 'Gå med i rum';
      } else {
        btn.textContent = 'Skapa nytt rum';
      }
    }
    
    function mainAction() {
      const code = document.getElementById('roomCode').value.trim();
      if (code.length > 0) {
        joinRoom();
      } else {
        createRoom();
      }
    }

    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) {
        showError('Ange ditt namn');
        return;
      }
      if (!socket) connectSocket();
      socket.emit('createRoom', name);
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const code = document.getElementById('roomCode').value.trim().toUpperCase();
      
      if (!name) {
        showError('Ange ditt namn');
        return;
      }
      if (!code || code.length !== 4) {
        showError('Ange en giltig rumskod (4 tecken)');
        return;
      }
      
      if (!socket) connectSocket();
      socket.emit('joinRoom', { code, name });
    }

    function leaveRoom() {
      if (socket) {
        socket.emit('leaveRoom');
      }
      gameState = null;
      selectedCardIds = [];
      clearSession();
      showScreen('menuScreen');
    }
    
    function hostEndGame() {
      if (socket) {
        socket.emit('hostEndGame');
      }
      document.getElementById('modal').classList.remove('visible');
      gameState = null;
      selectedCardIds = [];
      clearSession();
      showScreen('menuScreen');
    }
    
    function addBot() {
      if (socket) {
        socket.emit('addBot');
      }
    }
    
    function removeBot(botId) {
      if (socket) {
        socket.emit('removeBot', botId);
      }
    }
    
    function copyRoomCode() {
      const code = document.getElementById('displayRoomCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById('copyCodeBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Kopierad!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      });
    }
    
    function showInviteModal() {
      document.getElementById('inviteName').value = '';
      document.getElementById('inviteLinkContainer').style.display = 'none';
      document.getElementById('inviteLinkBox').textContent = '';
      document.getElementById('inviteLinkBox').classList.remove('copied');
      const btn = document.getElementById('generateLinkBtn');
      btn.textContent = 'Skapa länk';
      btn.onclick = generateInviteLink;
      document.getElementById('inviteModal').classList.add('visible');
    }
    
    function closeInviteModal() {
      document.getElementById('inviteModal').classList.remove('visible');
    }
    
    function generateInviteLink() {
      const name = document.getElementById('inviteName').value.trim();
      if (!name) {
        document.getElementById('inviteName').focus();
        return;
      }
      
      const code = document.getElementById('displayRoomCode').textContent;
      const baseUrl = window.location.origin + window.location.pathname;
      const link = `${baseUrl}?namn=${encodeURIComponent(name)}&rum=${code}`;
      
      const linkBox = document.getElementById('inviteLinkBox');
      linkBox.textContent = link;
      linkBox.onclick = function() { copyInviteLink(link); };
      document.getElementById('inviteLinkContainer').style.display = 'block';
      document.getElementById('generateLinkBtn').textContent = 'Kopiera länk';
      document.getElementById('generateLinkBtn').onclick = function() {
        copyInviteLink(link);
      };
    }
    
    function copyInviteLink(link) {
      navigator.clipboard.writeText(link).then(() => {
        const linkBox = document.getElementById('inviteLinkBox');
        linkBox.classList.add('copied');
        document.getElementById('generateLinkBtn').textContent = 'Kopierad!';
        setTimeout(() => {
          linkBox.classList.remove('copied');
          document.getElementById('generateLinkBtn').textContent = 'Kopiera länk';
        }, 2000);
      });
    }
    
    function setBotDifficulty(difficulty) {
      if (socket) {
        socket.emit('setBotDifficulty', difficulty);
      }
      // Uppdatera knapparna lokalt direkt för snabbare respons
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.difficulty === difficulty);
      });
    }
    
    function toggleHelpMode() {
      const checkbox = document.getElementById('helpModeCheckbox');
      const helpMode = checkbox.checked;
      
      if (socket) {
        socket.emit('setHelpMode', helpMode);
      }
      
      // Uppdatera beskrivning lokalt
      const desc = document.getElementById('helpModeDesc');
      desc.textContent = helpMode ? 'På - Spelbara kort markeras' : 'Av - Du måste tänka själv!';
    }
    
    let invalidModalTimeout = null;
    
    function showInvalidMoveModal(message) {
      const modal = document.getElementById('invalidMoveModal');
      const msgEl = document.getElementById('invalidMoveMessage');
      const btn = document.getElementById('invalidMoveBtn');
      
      msgEl.innerHTML = message;
      btn.disabled = true;
      modal.classList.add('visible');
      
      // Aktivera knappen efter 1.5 sekunder
      if (invalidModalTimeout) clearTimeout(invalidModalTimeout);
      invalidModalTimeout = setTimeout(() => {
        btn.disabled = false;
      }, 1500);
    }
    
    function closeInvalidModal() {
      const btn = document.getElementById('invalidMoveBtn');
      if (btn.disabled) return; // Kan inte stängas än
      
      document.getElementById('invalidMoveModal').classList.remove('visible');
      if (invalidModalTimeout) {
        clearTimeout(invalidModalTimeout);
        invalidModalTimeout = null;
      }
    }

    function startGame(mode) {
      socket.emit('startGame', mode);
    }

    // ============================================
    // SPELLOGIK
    // ============================================

    function toggleCard(cardId) {
      if (!gameState || gameState.roundEnded) return;
      
      const me = gameState.players.find(p => p.isMe);
      if (!me || !me.isCurrent) return;
      
      // Om hjälpläge är på, kolla om kortet är spelbart
      // Om hjälpläge är av, tillåt alla kort
      if (gameState.helpMode && !gameState.playableCardIds?.includes(cardId)) return;
      
      const index = selectedCardIds.indexOf(cardId);
      if (index >= 0) {
        selectedCardIds.splice(index, 1);
      } else {
        selectedCardIds.push(cardId);
      }
      
      render();
    }

    function selectAllPlayable() {
      if (!gameState || gameState.roundEnded) return;
      if (!gameState.playableCardIds) return;
      
      selectedCardIds = [...gameState.playableCardIds];
      render();
    }

    function playCards() {
      if (selectedCardIds.length === 0) return;
      
      console.log('Försöker spela kort:', selectedCardIds);
      console.log('Nuvarande tableau:', gameState.tableau);
      
      // Om hjälpläge är på, validera på klientsidan först
      // Om hjälpläge är av, låt servern validera
      if (gameState.helpMode) {
        if (!validateSelectedCards()) {
          console.log('Klient-validering misslyckades');
          showError('Ogiltigt val - korten kan inte spelas tillsammans');
          return;
        }
        console.log('Klient-validering OK, skickar till server');
      }
      
      socket.emit('playCards', selectedCardIds);
      // Rensa INTE här - vänta på gameState från servern
    }
    
    // Klient-validering av valda kort
    function validateSelectedCards() {
      if (selectedCardIds.length === 0) return false;
      if (!gameState || !gameState.tableau) return false;
      
      const me = gameState.players.find(p => p.isMe);
      if (!me || !me.hand) return false;
      
      const selectedCards = selectedCardIds
        .map(id => me.hand.find(c => c.id === id))
        .filter(Boolean);
      
      if (selectedCards.length !== selectedCardIds.length) return false;
      
      console.log('Validerar kort:', selectedCards.map(c => `${c.suit}-${c.rank}`));
      
      // Simulera getPlayableOrder
      const simTableau = {
        spades: gameState.tableau.spades ? { ...gameState.tableau.spades } : null,
        hearts: gameState.tableau.hearts ? { ...gameState.tableau.hearts } : null,
        clubs: gameState.tableau.clubs ? { ...gameState.tableau.clubs } : null,
        diamonds: gameState.tableau.diamonds ? { ...gameState.tableau.diamonds } : null
      };
      
      console.log('Startar med tableau:', JSON.stringify(simTableau));
      
      const remaining = [...selectedCards];
      
      while (remaining.length > 0) {
        let foundPlayable = false;
        
        for (let i = 0; i < remaining.length; i++) {
          const card = remaining[i];
          const canPlay = canPlayCardClient(card, simTableau);
          console.log(`Kan ${card.suit}-${card.rank} spelas?`, canPlay);
          
          if (canPlay) {
            remaining.splice(i, 1);
            
            if (!simTableau[card.suit]) {
              simTableau[card.suit] = { low: card.rank, high: card.rank };
            } else {
              if (card.rank < simTableau[card.suit].low) {
                simTableau[card.suit].low = card.rank;
              }
              if (card.rank > simTableau[card.suit].high) {
                simTableau[card.suit].high = card.rank;
              }
            }
            
            console.log('Uppdaterat tableau:', JSON.stringify(simTableau));
            foundPlayable = true;
            break;
          }
        }
        
        if (!foundPlayable) {
          console.log('Kunde inte hitta spelbart kort, kvar:', remaining.map(c => `${c.suit}-${c.rank}`));
          return false;
        }
      }
      
      console.log('Alla kort kan spelas!');
      return true;
    }
    
    function canPlayCardClient(card, tableau) {
      const anyCardPlayed = Object.values(tableau).some(s => s !== null);
      if (!anyCardPlayed) {
        return card.suit === 'spades' && card.rank === 7;
      }
      
      const suitState = tableau[card.suit];
      
      if (!suitState) {
        return card.rank === 7;
      }
      
      return card.rank === suitState.low - 1 || card.rank === suitState.high + 1;
    }

    function pass() {
      socket.emit('pass');
    }

    function nextRound() {
      socket.emit('nextRound');
      document.getElementById('modal').classList.remove('visible');
    }

    function newGame() {
      socket.emit('newGame');
      document.getElementById('modal').classList.remove('visible');
    }

    function handleModalClick(event) {
      if (event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('visible');
      }
    }

    // ============================================
    // RENDERING
    // ============================================

    function render() {
      if (!gameState) return;

      if (gameState.state === 'lobby') {
        renderLobby();
        showScreen('lobbyScreen');
      } else {
        renderGame();
        showScreen('gameScreen');
        
        if (gameState.roundEnded) {
          setTimeout(() => showResultModal(), 500);
        }
      }
    }

    function renderLobby() {
      const list = document.getElementById('lobbyPlayerList');
      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const hasBots = gameState.hasBots || gameState.players.some(p => p.isBot);
      
      list.innerHTML = gameState.players.map(p => `
        <div class="player-list-item ${p.isMe ? 'is-me' : ''} ${p.isBot ? 'is-bot' : ''}">
          <div class="player-avatar">${p.isBot ? '🤖' : p.name.charAt(0).toUpperCase()}</div>
          <div class="player-info">
            <div class="name">${p.name}${p.isMe ? ' (du)' : ''}</div>
            <div class="role">${p.isHost ? 'Värd' : (p.isBot ? 'Robot' : 'Spelare')}</div>
          </div>
          ${p.isHost ? '<span class="host-badge">VÄRD</span>' : ''}
          ${p.isBot && isHost ? `<button class="remove-bot-btn" onclick="removeBot('${p.id}')">✕</button>` : ''}
        </div>
      `).join('');

      const canStart = gameState.players.length >= 3;
      const canAddBot = gameState.players.length < 7;
      
      document.getElementById('hostControls').style.display = isHost ? 'block' : 'none';
      document.getElementById('startQuickBtn').disabled = !canStart;
      document.getElementById('startStandardBtn').disabled = !canStart;
      
      // Uppdatera robot-knappen
      const botBtnContainer = document.getElementById('botButtonContainer');
      if (botBtnContainer) {
        botBtnContainer.innerHTML = isHost && canAddBot ? `
          <button class="btn btn-secondary add-bot-btn" onclick="addBot()">
            🤖 Lägg till robot
          </button>
        ` : '';
      }
      
      // Visa/göm svårighetsgrad för robotar
      const difficultyContainer = document.getElementById('botDifficultyContainer');
      if (difficultyContainer) {
        difficultyContainer.style.display = (isHost && hasBots) ? 'block' : 'none';
        
        // Uppdatera aktiv knapp
        const currentDifficulty = gameState.botDifficulty || 'dumb';
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.difficulty === currentDifficulty);
        });
      }
      
      // Visa/göm hjälpläge-toggle (alltid synlig för värd)
      const helpModeContainer = document.getElementById('helpModeContainer');
      if (helpModeContainer) {
        helpModeContainer.style.display = isHost ? 'block' : 'none';
        
        // Uppdatera checkbox och beskrivning
        const checkbox = document.getElementById('helpModeCheckbox');
        const desc = document.getElementById('helpModeDesc');
        const helpMode = gameState.helpMode || false;
        
        checkbox.checked = helpMode;
        desc.textContent = helpMode ? 'På - Spelbara kort markeras' : 'Av - Du måste tänka själv!';
      }
      
      document.getElementById('waitingText').textContent = canStart 
        ? `${gameState.players.length} spelare redo`
        : `Minst 3 spelare krävs (${gameState.players.length}/3)`;
    }

    function renderGame() {
      renderTableau();
      renderPlayers();
      renderInfo();
      renderGameFooter();
    }
    
    function renderGameFooter() {
      const footer = document.getElementById('gameFooter');
      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const isRoundEnd = gameState.roundEnded || gameState.state === 'roundEnd';
      const isGameOver = gameState.isGameOver;
      
      if (isHost && isRoundEnd) {
        footer.innerHTML = `
          <button class="modal-btn" onclick="${isGameOver ? 'newGame()' : 'nextRound()'}">
            ${isGameOver ? 'Nytt spel' : 'Nästa runda'}
          </button>
          <button class="modal-btn secondary" onclick="hostEndGame()">Avsluta</button>
        `;
      } else {
        footer.innerHTML = `
          <button class="quit-btn" onclick="leaveRoom()">Lämna spel</button>
        `;
      }
    }

    function renderTableau() {
      const container = document.getElementById('tableau');
      container.innerHTML = '';
      
      const lastPlayed = gameState.lastPlayedCards || [];

      for (const suit of SUITS) {
        const suitState = gameState.tableau[suit];
        const colorClass = SUIT_COLORS[suit];
        
        const column = document.createElement('div');
        column.className = 'suit-column';

        // Övre delen
        const upperStack = document.createElement('div');
        upperStack.className = 'card-stack-upper';

        if (suitState && suitState.high > 7) {
          const highCard = document.createElement('div');
          const isKing = suitState.high === 13;
          const isLastPlayed = lastPlayed.includes(`${suit}-${suitState.high}`);
          highCard.className = `table-card ${colorClass}${isKing ? ' completed' : ''}${isLastPlayed ? ' last-played' : ''}`;
          highCard.innerHTML = `
            <span class="rank">${RANK_NAMES[suitState.high]}</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          upperStack.appendChild(highCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = suitState ? '8' : '';
          placeholder.style.visibility = suitState ? 'visible' : 'hidden';
          upperStack.appendChild(placeholder);
        }

        column.appendChild(upperStack);

        // Mitten (7:an)
        const sevenStack = document.createElement('div');
        sevenStack.className = 'card-stack-seven';

        if (suitState) {
          const sevenCard = document.createElement('div');
          const isLastPlayed = lastPlayed.includes(`${suit}-7`);
          sevenCard.className = `table-card ${colorClass} seven${isLastPlayed ? ' last-played' : ''}`;
          sevenCard.innerHTML = `
            <span class="rank">7</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          sevenStack.appendChild(sevenCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = '7';
          sevenStack.appendChild(placeholder);
        }

        column.appendChild(sevenStack);

        // Nedre delen
        const lowerStack = document.createElement('div');
        lowerStack.className = 'card-stack-lower';

        if (suitState && suitState.low < 7) {
          const lowCard = document.createElement('div');
          const isAce = suitState.low === 1;
          const isLastPlayed = lastPlayed.includes(`${suit}-${suitState.low}`);
          lowCard.className = `table-card ${colorClass}${isAce ? ' completed' : ''}${isLastPlayed ? ' last-played' : ''}`;
          lowCard.innerHTML = `
            <span class="rank">${RANK_NAMES[suitState.low]}</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          lowerStack.appendChild(lowCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = suitState ? '6' : '';
          placeholder.style.visibility = suitState ? 'visible' : 'hidden';
          lowerStack.appendChild(placeholder);
        }

        column.appendChild(lowerStack);
        container.appendChild(column);
      }
    }

    function renderPlayers() {
      const container = document.getElementById('playersArea');
      container.innerHTML = '';

      // Sortera så att egen spelare visas först
      const sortedPlayers = [...gameState.players].sort((a, b) => {
        if (a.isMe) return -1;
        if (b.isMe) return 1;
        return 0;
      });

      for (const player of sortedPlayers) {
        const section = document.createElement('div');
        section.className = `player-section ${player.isCurrent && !gameState.roundEnded ? 'current-player' : ''} ${player.isMe ? 'is-me' : ''} ${player.isWinner ? 'winner' : ''} ${player.isBot ? 'is-bot' : ''}`;

        const hasPlayable = gameState.playableCardIds?.length > 0;
        const canPass = player.isCurrent && player.isMe && !hasPlayable && !gameState.roundEnded;

        section.innerHTML = `
          <div class="player-header">
            <div class="player-name">
              ${player.isBot ? '🤖 ' : ''}${player.name}${player.isMe ? ' (du)' : ''}
              ${player.isDealer ? '<span class="dealer-badge">Gav</span>' : ''}
              ${player.isStarter ? '<span class="starter-badge">Började</span>' : ''}
              ${player.isWinner ? '<span class="winner-badge">🏆 Vinnare!</span>' : ''}
              ${player.isCurrent && !gameState.roundEnded ? '<span class="player-badge">Spelar</span>' : ''}
              ${player.hasAsken ? '<span class="asken-icon" title="Har asken">📦</span>' : ''}
            </div>
            <div class="player-stats">
              <span>${player.cardCount} kort</span>
              <span>•</span>
              <span>Poäng: ${player.score}</span>
            </div>
          </div>
          ${player.isMe && player.hand ? renderOwnHand(player) : renderHiddenHand(player.cardCount)}
          ${player.isMe && player.isCurrent && !gameState.roundEnded ? `
            <div class="action-buttons">
              <button class="action-btn play" onclick="playCards()" ${selectedCardIds.length === 0 || (gameState.helpMode && !validateSelectedCards()) ? 'disabled' : ''}>
                Spela ${selectedCardIds.length > 0 ? '(' + selectedCardIds.length + ' kort)' : ''}
              </button>
              <button class="action-btn pass" onclick="pass()" ${!canPass ? 'disabled' : ''}>
                Passa ${canPass ? '(ta asken)' : ''}
              </button>
            </div>
          ` : ''}
        `;

        container.appendChild(section);
      }
    }

    function renderOwnHand(player) {
      const hasPlayable = gameState.playableCardIds?.length > 0 && player.isCurrent && !gameState.roundEnded;
      const showHelpButton = hasPlayable && gameState.helpMode; // Visa bara om hjälp är på
      
      return `
        <div class="player-hand-container">
          <div class="player-hand">
            ${player.hand.map(card => {
              const isPlayable = gameState.playableCardIds?.includes(card.id) && player.isCurrent && !gameState.roundEnded;
              const isSelected = selectedCardIds.includes(card.id);
              const colorClass = SUIT_COLORS[card.suit];
              // Om hjälpläge är av, markera inte kort som disabled
              const disabledClass = gameState.helpMode ? (isPlayable ? 'playable' : 'disabled') : 'playable';
              return `
                <div class="card ${colorClass} ${disabledClass} ${isSelected ? 'selected' : ''}"
                     onclick="toggleCard('${card.id}')">
                  <span class="card-rank">${RANK_NAMES[card.rank]}</span>
                  <span class="card-suit">${SUIT_SYMBOLS[card.suit]}</span>
                </div>
              `;
            }).join('')}
          </div>
          ${showHelpButton ? `
            <button class="select-all-btn" onclick="selectAllPlayable()" title="Välj alla spelbara kort">
              💡
            </button>
          ` : ''}
        </div>
      `;
    }

    function renderHiddenHand(count) {
      return `
        <div class="hidden-hand">
          ${Array(count).fill('<div class="card-back"></div>').join('')}
        </div>
      `;
    }

    function renderInfo() {
      let titleText = `RUNDA ${gameState.roundNumber}`;
      
      if (gameState.roundEnded && gameState.roundWinners.length > 0) {
        if (gameState.roundWinners.length === 1) {
          titleText += ` SLUT • 🏆 ${gameState.roundWinners[0].name.toUpperCase()} VANN!`;
        } else {
          const names = gameState.roundWinners.map(w => w.name.toUpperCase());
          let winnerText;
          if (names.length === 2) {
            winnerText = names[0] + ' OCH ' + names[1];
          } else {
            const last = names.pop();
            winnerText = names.join(', ') + ' OCH ' + last;
          }
          titleText += ` SLUT • 🏆 ${winnerText} DELAR VINSTEN!`;
        }
      } else if (gameState.askenHolderId) {
        const holder = gameState.players.find(p => p.id === gameState.askenHolderId);
        titleText += ` • ${holder?.name?.toUpperCase() || 'OKÄND'} HAR ASKEN`;
      } else {
        titleText += ' • INGEN HAR ASKEN';
      }
      
      document.getElementById('tableauTitle').textContent = titleText;
    }

    function showResultModal() {
      const isGameOver = gameState.isGameOver;
      
      document.getElementById('modalTitle').textContent = isGameOver ? 'Spelet slut!' : `Runda ${gameState.roundNumber} slut!`;
      
      // Bestäm vinnare
      let winners;
      if (isGameOver) {
        // Spelvinnare = lägst TOTALPOÄNG
        const lowestTotal = Math.min(...gameState.players.map(p => p.score));
        winners = gameState.players.filter(p => p.score === lowestTotal);
      } else {
        // Rundvinnare = lägst poäng DENNA RUNDA (kommer från servern)
        winners = gameState.roundWinners;
      }
      
      if (winners.length === 1) {
        const winText = isGameOver ? 'vinner spelet!' : 'vinner rundan!';
        document.getElementById('modalWinner').textContent = `🏆 ${winners[0].name} ${winText}`;
      } else {
        const names = winners.map(w => w.name);
        let winnerText;
        if (names.length === 2) {
          winnerText = names[0] + ' och ' + names[1];
        } else {
          const last = names.pop();
          winnerText = names.join(', ') + ' och ' + last;
        }
        const winText = isGameOver ? 'delar på segern!' : 'delar på vinsten!';
        document.getElementById('modalWinner').textContent = `🏆 ${winnerText} ${winText}`;
      }

      // Sortera spelare för tabellen
      let playersToShow = [...gameState.players];
      if (isGameOver) {
        // Sortera efter totalpoäng (lägst först = bäst placering)
        playersToShow.sort((a, b) => a.score - b.score);
      }
      
      // Uppdatera tabellhuvud
      const thead = document.querySelector('#scoreTable thead tr');
      if (isGameOver) {
        thead.innerHTML = `
          <th>Plats</th>
          <th>Spelare</th>
          <th>Kort</th>
          <th>Poäng</th>
          <th>Asken</th>
          <th>Totalt</th>
        `;
      } else {
        thead.innerHTML = `
          <th>Spelare</th>
          <th>Kort</th>
          <th>Poäng</th>
          <th>Asken</th>
          <th>Totalt</th>
        `;
      }

      // Poängtabell
      const tbody = document.getElementById('scoreBody');
      let currentPlace = 0;
      let lastScore = -1;
      
      tbody.innerHTML = playersToShow.map((p, index) => {
        // Hitta rundpoäng för denna spelare
        const roundScore = gameState.roundScores?.find(rs => rs.playerId === p.id);
        const cardPoints = roundScore ? roundScore.cardPoints : 0;
        const askenPoints = roundScore ? roundScore.askenPoints : 0;
        
        // Beräkna placering (hantera delade placeringar)
        if (p.score !== lastScore) {
          currentPlace = index + 1;
          lastScore = p.score;
        }
        
        const placeEmoji = currentPlace === 1 ? '🥇' : currentPlace === 2 ? '🥈' : currentPlace === 3 ? '🥉' : '💀';
        const placeText = `${placeEmoji} ${currentPlace}`;
        
        if (isGameOver) {
          return `
            <tr class="${currentPlace === 1 ? 'winner-row' : ''}">
              <td class="place-cell">${placeText}</td>
              <td>${p.name}${p.isMe ? ' (du)' : ''}</td>
              <td>${p.cardCount}</td>
              <td>${cardPoints}</td>
              <td class="${askenPoints > 0 ? 'asken-cell' : ''}">${askenPoints > 0 ? '+' + askenPoints : '—'}</td>
              <td class="total">${p.score}</td>
            </tr>
          `;
        } else {
          return `
            <tr>
              <td>${p.name}${p.isMe ? ' (du)' : ''}</td>
              <td>${p.cardCount}</td>
              <td>${cardPoints}</td>
              <td class="${askenPoints > 0 ? 'asken-cell' : ''}">${askenPoints > 0 ? '+' + askenPoints : '—'}</td>
              <td class="total">${p.score}</td>
            </tr>
          `;
        }
      }).join('');

      // Knappar
      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const buttonsHtml = isHost ? `
        <button class="modal-btn" onclick="${isGameOver ? 'newGame()' : 'nextRound()'}">
          ${isGameOver ? 'Nytt spel' : 'Nästa runda'}
        </button>
        <button class="modal-btn secondary" onclick="hostEndGame()">Avsluta</button>
      ` : `
        <p class="not-host-msg">Väntar på att värden ska fortsätta...</p>
      `;
      document.getElementById('modalButtons').innerHTML = buttonsHtml;

      document.getElementById('modal').classList.add('visible');
    }

    // ============================================
    // INIT
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      connectSocket();
      
      // Läs URL-parametrar (för inbjudningslänkar)
      const urlParams = new URLSearchParams(window.location.search);
      const inviteName = urlParams.get('namn');
      const inviteRoom = urlParams.get('rum');
      
      if (inviteName) {
        document.getElementById('playerName').value = inviteName;
      }
      if (inviteRoom) {
        document.getElementById('roomCode').value = inviteRoom.toUpperCase();
        updateMainButton();
      }
      
      // Rensa URL-parametrar utan att ladda om sidan
      if (inviteName || inviteRoom) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Enter-tangent för att gå med
      document.getElementById('roomCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') mainAction();
      });
      document.getElementById('playerName').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') mainAction();
      });
    });
  </script>
</body>
</html>
