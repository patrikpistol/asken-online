<!DOCTYPE html>
<!--
  Asken Online - Det klassiska svenska kortspelet
  
  Skapat av Patrik Pistol f√∂r Pistol Reklambyr√• AB
  https://pistol.se | https://patrikpistol.com
  
  ¬© 2024 Pistol Reklambyr√• AB
-->
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- SEO Meta Tags -->
  <title>Asken Online ‚Äì Spela klassiska kortspelet gratis</title>
  <meta name="description" content="Spela Asken online gratis med v√§nner! Det klassiska svenska kortspelet d√§r du t√§vlar om att bli av med alla kort f√∂rst. Skapa rum, bjud in v√§nner och spela direkt i webbl√§saren.">
  <meta name="keywords" content="Asken, kortspel, svenska kortspel, spela online, multiplayer, gratis, v√§nner, spelkv√§ll, sjuor, kortlek">
  <meta name="author" content="Patrik Pistol, Pistol Reklambyr√• AB">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://asken.pistol.se/">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://asken.pistol.se/">
  <meta property="og:title" content="Asken Online ‚Äì Spela klassiska kortspelet gratis">
  <meta property="og:description" content="Spela Asken online gratis med v√§nner! Det klassiska svenska kortspelet d√§r du t√§vlar om att bli av med alla kort f√∂rst.">
  <meta property="og:image" content="https://asken.pistol.se/gfx/open_graph.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="sv_SE">
  <meta property="og:site_name" content="Asken Online">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://asken.pistol.se/">
  <meta name="twitter:title" content="Asken Online ‚Äì Spela klassiska kortspelet gratis">
  <meta name="twitter:description" content="Spela Asken online gratis med v√§nner! Det klassiska svenska kortspelet d√§r du t√§vlar om att bli av med alla kort f√∂rst.">
  <meta name="twitter:image" content="https://asken.pistol.se/gfx/open_graph.jpg">
  
  <!-- Favicons & PWA -->
  <link rel="icon" type="image/x-icon" href="/gfx/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/gfx/web-app-manifest-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/gfx/web-app-manifest-512x512.png">
  <link rel="apple-touch-icon" href="/gfx/web-app-manifest-192x192.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Asken">
  
  <!-- Structured Data / JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Asken Online",
    "description": "Spela det klassiska svenska kortspelet Asken online gratis med v√§nner. Skapa rum, bjud in v√§nner och t√§vla om att bli av med alla kort f√∂rst.",
    "url": "https://asken.pistol.se/",
    "applicationCategory": "GameApplication",
    "genre": "Card Game",
    "operatingSystem": "Any",
    "browserRequirements": "Requires JavaScript",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "SEK"
    },
    "creator": {
      "@type": "Person",
      "name": "Patrik Pistol",
      "url": "https://patrikpistol.com"
    },
    "author": {
      "@type": "Person",
      "name": "Patrik Pistol",
      "url": "https://patrikpistol.com"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Pistol Reklambyr√• AB",
      "url": "https://pistol.se"
    },
    "inLanguage": "sv",
    "screenshot": "https://asken.pistol.se/gfx/open_graph.jpg"
  }
  </script>
  
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg-dark: #1a1a1a;
      --bg-card: #2a2a2a;
      --bg-felt: #2d5a4a;
      --bg-felt-dark: #1e3d32;
      --text: #f0f0f0;
      --text-dim: #888;
      --accent: #c69e60;
      --accent-hover: #b08a50;
      --gold: #c69e60;
      --red: #e05252;
      --green: #4caf50;
      --card-shadow: 0 4px 15px rgba(0,0,0,0.3);
      --glow: 0 0 20px rgba(198, 158, 96, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark) url('gfx/bg_wood.webp') repeat;
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 8px;
    }

    h2 {
      font-size: 1.3rem;
      margin-bottom: 16px;
    }

    /* ============================================
       LOBBY / JOIN SK√ÑRMAR
       ============================================ */
    
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .menu-card {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 600px;
      margin: 40px auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .menu-card h1 {
      margin-bottom: 24px;
    }
    
    .game-logo {
      max-width: 280px;
      height: auto;
      display: block;
      margin: 0 auto 24px auto;
    }
    
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: var(--text-dim);
    }

    .form-group input {
      width: 100%;
      padding: 14px;
      border: 2px solid #404040;
      border-radius: 10px;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      height: 50px;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input.code-input {
      text-transform: uppercase;
      letter-spacing: 4px;
      text-align: center;
      font-size: 1rem;
      font-weight: bold;
    }

    .btn {
      width: 100%;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
      display: block;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 2px solid #404040;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .rules-link {
      display: inline;
      color: var(--text-dim);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }
    
    .rules-link:hover {
      color: var(--accent);
    }
    
    .footer-links {
      text-align: center;
      margin-top: 16px;
    }
    
    /* Dela spelet */
    .share-section {
      margin-top: 24px;
      text-align: center;
    }
    
    .share-title {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .share-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    
    .share-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      transition: all 0.2s;
      opacity: 0.8;
    }
    
    .share-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .share-btn svg {
      width: 32px;
      height: 32px;
      display: block;
    }
    
    .credit-link {
      margin-top: 20px;
      text-align: center;
    }
    
    .credit-link a {
      color: var(--text-dim);
      text-decoration: none;
      font-size: 0.8rem;
      transition: color 0.2s;
    }
    
    .credit-link a:hover {
      color: var(--accent);
    }
    
    /* Matchmaking */
    .matchmaking-info {
      text-align: center;
      padding: 20px 0;
    }
    
    .matchmaking-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(198, 158, 96, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .matchmaking-queue,
    .matchmaking-position {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin: 8px 0;
    }
    
    .matchmaking-queue span,
    .matchmaking-position span {
      color: var(--accent);
      font-weight: bold;
    }
    
    .host-notice {
      color: var(--green);
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
    }
    
    #matchmakingControls {
      margin: 20px 0;
    }
    
    /* ============================================
       CHAT
       ============================================ */
    
    .chat-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .chat-toggle:hover {
      transform: scale(1.1);
      background: var(--accent);
    }
    
    .chat-toggle:hover svg {
      fill: var(--bg-dark);
    }
    
    .chat-toggle svg {
      width: 24px;
      height: 24px;
      fill: var(--accent);
      transition: fill 0.2s;
    }
    
    .chat-toggle .chat-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--red);
      color: white;
      font-size: 0.7rem;
      font-weight: bold;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    
    .chat-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .chat-modal.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .chat-container {
      background: var(--bg-card);
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .chat-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text);
    }
    
    .chat-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      transition: color 0.2s;
    }
    
    .chat-close:hover {
      color: var(--red);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      min-height: 200px;
      max-height: 400px;
    }
    
    .chat-message {
      margin-bottom: 12px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    
    .chat-message.system {
      background: rgba(198, 158, 96, 0.15);
      color: var(--accent);
      font-style: italic;
      text-align: center;
      font-size: 0.85rem;
    }
    
    .chat-message .chat-sender {
      font-weight: 600;
      color: var(--accent);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    
    .chat-message .chat-text {
      color: var(--text);
      word-wrap: break-word;
    }
    
    .chat-message .chat-time {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-top: 4px;
    }
    
    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .chat-input-area input {
      flex: 1;
      padding: 12px;
      border: 2px solid #404040;
      border-radius: 8px;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 0.95rem;
      font-family: inherit;
    }
    
    .chat-input-area input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .chat-send-btn {
      padding: 12px 20px;
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .chat-send-btn:hover {
      background: var(--accent-hover);
    }
    
    .chat-empty {
      color: var(--text-dim);
      text-align: center;
      font-style: italic;
      padding: 40px 20px;
    }

    .divider {
      text-align: center;
      margin: 24px 0;
      color: var(--text-dim);
      font-size: 0.85rem;
    }

    .error-msg {
      background: rgba(224, 82, 82, 0.15);
      border: 1px solid var(--red);
      color: var(--red);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    .error-msg.game-error {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 14px 28px;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid var(--red);
      color: #ff6b6b;
      font-weight: 600;
      animation: shake 0.5s ease-in-out;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(-50%); }
      20%, 60% { transform: translateX(calc(-50% - 10px)); }
      40%, 80% { transform: translateX(calc(-50% + 10px)); }
    }

    /* ============================================
       LOBBY (v√§ntar p√• spelare)
       ============================================ */

    .lobby-card {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 600px;
      margin: 40px auto;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .room-code-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .room-code {
      font-size: 3rem;
      font-weight: bold;
      letter-spacing: 12px;
      color: var(--accent);
      margin: 24px 0;
      font-family: monospace;
    }
    
    .copy-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .copy-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .copy-btn.copied {
      background: rgba(76, 175, 80, 0.3);
      border-color: #4caf50;
    }
    
    .invite-btn {
      background: transparent;
      border: 1px solid #505050;
      border-radius: 6px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      padding: 8px 20px;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .invite-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .invite-btn.copied {
      border-color: var(--green);
      color: var(--green);
    }
    
    .lobby-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .room-code-label {
      font-size: 0.9rem;
      color: var(--text-dim);
    }

    .player-list {
      margin: 24px 0;
      text-align: left;
    }

    .player-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-dark);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .player-list-item.is-me {
      border: 2px solid var(--accent);
    }

    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .player-info {
      flex: 1;
    }

    .player-info .name {
      font-weight: 600;
    }

    .player-info .role {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .host-badge {
      background: var(--accent);
      color: var(--bg-dark);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .player-list-item.is-bot {
      border: 1px dashed rgba(255, 255, 255, 0.3);
    }
    
    .player-list-item.is-bot .player-avatar {
      background: #6c5ce7;
      font-size: 1.3rem;
    }
    
    .remove-bot-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: rgba(224, 82, 82, 0.2);
      color: var(--red);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .remove-bot-btn:hover {
      background: rgba(224, 82, 82, 0.4);
    }
    
    .add-bot-btn {
      margin-bottom: 16px;
    }

    .waiting-text {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    .mode-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 16px;
      background: var(--bg-dark);
      border: 2px solid #404040;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .mode-btn.active {
      border-color: var(--accent);
      background: rgba(198, 158, 96, 0.1);
    }

    .mode-btn span {
      display: block;
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 4px;
    }
    
    .start-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .start-btn {
      flex: 1;
      padding: 16px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .start-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }
    
    .start-btn:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
    }
    
    .start-btn span {
      display: block;
      font-size: 0.8rem;
      font-weight: 400;
      opacity: 0.8;
      margin-top: 4px;
    }
    
    .difficulty-label {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 10px;
    }
    
    .difficulty-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .difficulty-btn {
      flex: 1;
      padding: 10px 12px;
      background: var(--bg-dark);
      border: 2px solid #404040;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 0.9rem;
    }
    
    .difficulty-btn.active {
      border-color: var(--accent);
      background: rgba(198, 158, 96, 0.1);
    }
    
    .difficulty-btn:hover:not(.active) {
      border-color: #606060;
    }
    
    /* Help Mode Toggle */
    .help-mode-toggle {
      margin: 16px 0;
      text-align: center;
    }
    
    .toggle-label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      gap: 12px;
    }
    
    .toggle-label input {
      display: none;
    }
    
    .toggle-slider {
      width: 48px;
      height: 26px;
      background: #404040;
      border-radius: 13px;
      position: relative;
      transition: background 0.3s;
    }
    
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--text);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.3s;
    }
    
    .toggle-label input:checked + .toggle-slider {
      background: var(--accent);
    }
    
    .toggle-label input:checked + .toggle-slider::before {
      transform: translateX(22px);
    }
    
    .toggle-text {
      font-size: 0.95rem;
      color: var(--text);
    }
    
    .help-mode-desc {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 6px;
    }
    
    /* Invalid Move Modal */
    .invalid-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .invalid-modal.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .invalid-modal-content {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 28px;
      max-width: 350px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    
    .invalid-modal-title {
      font-size: 1.4rem;
      color: var(--red);
      margin-bottom: 16px;
      font-weight: 600;
    }
    
    .invalid-modal-message {
      color: var(--text);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .invalid-modal-btn {
      padding: 12px 32px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .invalid-modal-btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }
    
    .invalid-modal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ============================================
       SPELSK√ÑRM
       ============================================ */

    .game-screen {
      padding-bottom: 20px;
    }

    .tableau-container {
      background: var(--bg-felt) url('gfx/bg_tyg.webp') repeat;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 
        inset 0 2px 10px rgba(0,0,0,0.3),
        0 8px 32px rgba(0,0,0,0.4);
    }

    .tableau-title {
      text-align: center;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .tableau {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 16px;
    }

    .suit-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      min-width: 75px;
      flex-shrink: 0;
      overflow: visible;
    }

    .card-stack-upper {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 76px;
      justify-content: flex-end;
      flex-shrink: 0;
      overflow: visible;
    }

    .card-stack-seven {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 76px;
      flex-shrink: 0;
      overflow: visible;
    }

    .card-stack-lower {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 76px;
      justify-content: flex-start;
      flex-shrink: 0;
      overflow: visible;
    }

    .table-card {
      width: 52px;
      height: 72px;
      background: white;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      position: relative;
      flex-shrink: 0;
    }

    .table-card.red { color: var(--red); }
    .table-card.black { color: #222; }

    .table-card .rank { font-size: 1.1rem; }
    .table-card .suit { font-size: 1.3rem; }

    .table-card.seven {
      background: linear-gradient(135deg, #fff9e6, #fff);
      box-shadow: 0 2px 12px rgba(198, 158, 96, 0.4);
    }

    .table-card.completed {
      background: linear-gradient(135deg, #e0e0e0, #c8c8c8);
      opacity: 0.7;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .table-card.completed.red { color: #a06060; }
    .table-card.completed.black { color: #606060; }
    
    .table-card.last-played {
      position: relative;
      box-shadow: 
        0 0 0 3px #ffd700,
        0 0 12px 4px rgba(255, 215, 0, 0.7),
        0 0 25px 8px rgba(255, 215, 0, 0.4);
      z-index: 20;
      animation: lastPlayedPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes lastPlayedPulse {
      0%, 100% {
        box-shadow: 
          0 0 0 3px #ffd700,
          0 0 12px 4px rgba(255, 215, 0, 0.7),
          0 0 25px 8px rgba(255, 215, 0, 0.4);
      }
      50% {
        box-shadow: 
          0 0 0 4px #ffd700,
          0 0 18px 6px rgba(255, 215, 0, 0.9),
          0 0 35px 12px rgba(255, 215, 0, 0.5);
      }
    }

    .card-placeholder {
      width: 52px;
      height: 72px;
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.4);
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* ============================================
       SPELARE
       ============================================ */

    .players-area {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .player-section {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 14px;
      padding: 16px 20px;
      transition: all 0.3s;
      border: 2px solid transparent;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .player-section.current-player {
      border-color: var(--accent);
      box-shadow: var(--glow), 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .player-section.is-me {
      background: linear-gradient(135deg, rgba(50, 50, 50, 0.8), rgba(50, 50, 50, 0.9)), url('gfx/bg_dark_steel.webp') repeat;
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .player-name {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: var(--accent);
      color: var(--bg-dark);
      border-radius: 4px;
      font-weight: 600;
    }

    .dealer-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: rgba(255,255,255,0.15);
      color: var(--text);
      border-radius: 4px;
      font-weight: 500;
    }
    
    .starter-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: rgba(0, 0, 0, 0.4);
      color: #aaa;
      border-radius: 4px;
      font-weight: 500;
    }

    .winner-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      background: linear-gradient(135deg, #ffd700, #ffb700);
      color: var(--bg-dark);
      border-radius: 4px;
      font-weight: 600;
      animation: winner-glow 1s ease-in-out infinite alternate;
    }

    @keyframes winner-glow {
      from { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
      to { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
    }

    .asken-icon {
      font-size: 1rem;
    }

    .player-stats {
      display: flex;
      gap: 16px;
      color: var(--text-dim);
      font-size: 0.85rem;
    }

    .player-hand-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .player-hand {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      min-height: 90px;
      align-items: flex-start;
      flex: 1;
    }

    .card {
      width: 56px;
      height: 78px;
      background: white;
      border-radius: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease-out, border-color 0.15s, box-shadow 0.15s;
      box-shadow: var(--card-shadow);
      user-select: none;
      position: relative;
      border: 2px solid transparent;
      -webkit-transform: translateY(0);
      transform: translateY(0);
      will-change: transform;
      -webkit-tap-highlight-color: transparent;
    }

    .card.red { color: var(--red); }
    .card.black { color: #222; }

    @media (hover: hover) {
      .card:hover:not(.disabled):not(.selected) {
        -webkit-transform: translateY(-10px);
        transform: translateY(-10px);
      }
    }

    .card.selected {
      -webkit-transform: translateY(-14px) !important;
      transform: translateY(-14px) !important;
      border-color: var(--accent);
      box-shadow: 0 8px 25px rgba(198, 158, 96, 0.5);
    }

    .card:not(.selected) {
      -webkit-transform: translateY(0);
      transform: translateY(0);
    }

    .card.playable {
      background: linear-gradient(135deg, #fffef5, #fff);
      cursor: pointer;
    }

    .card.playable::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border: 2px solid var(--green);
      border-radius: 9px;
      opacity: 0.6;
      animation: playable-pulse 2s infinite;
    }

    @keyframes playable-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .card.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .card .card-rank {
      font-size: 1.15rem;
      line-height: 1;
    }

    .card .card-suit {
      font-size: 1.4rem;
      line-height: 1;
    }

    /* Kort-baksida (andras kort) */
    .card-back {
      width: 32px;
      height: 46px;
      background: linear-gradient(135deg, #606060, #4a4a4a);
      border-radius: 4px;
      border: 1px solid #707070;
      box-shadow: 1px 0 2px rgba(0,0,0,0.3);
      flex-shrink: 0;
    }

    .hidden-hand {
      display: flex;
      flex-wrap: wrap;
      min-height: 50px;
      padding-left: 8px;
    }

    .hidden-hand .card-back {
      margin-left: -8px;
    }

    .select-all-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .select-all-btn:hover {
      background: var(--accent);
      color: var(--bg-dark);
      transform: scale(1.1);
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn.play {
      background: var(--green);
      color: white;
    }

    .action-btn.play:hover:not(:disabled) {
      background: #5cbf60;
    }

    .action-btn.pass {
      background: var(--red);
      color: white;
    }

    .action-btn.pass:hover:not(:disabled) {
      background: #e86565;
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ============================================
       MODAL
       ============================================ */

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-card) url('gfx/bg_dark_steel.webp') repeat;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    }

    .modal h2 {
      margin-bottom: 8px;
    }

    .winner {
      font-size: 1.3rem;
      color: var(--accent);
      margin-bottom: 24px;
    }

    .score-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .score-table th,
    .score-table td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #404040;
    }

    .score-table th {
      color: var(--text-dim);
      font-weight: 500;
      font-size: 0.8rem;
    }

    .score-table td:first-child {
      text-align: left;
    }

    .score-table .total {
      font-weight: 600;
      color: var(--accent);
    }

    .score-table .asken-cell {
      color: var(--red);
    }
    
    .score-table .place-cell {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .score-table .winner-row {
      background: rgba(198, 158, 96, 0.15);
    }
    
    .score-table .winner-row td {
      border-bottom-color: var(--gold);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    .modal-btn {
      padding: 14px 36px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .modal-btn.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.7);
    }

    .modal-btn.secondary:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .modal-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
      margin-top: 16px;
    }
    
    .invite-link-label {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 8px;
      text-align: left;
    }
    
    .invite-link-box {
      background: var(--bg-dark);
      border: 2px solid #404040;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.85rem;
      word-break: break-all;
      text-align: left;
      color: var(--accent);
      margin-bottom: 16px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    .invite-link-box:hover {
      border-color: var(--accent);
    }
    
    .invite-link-box.copied {
      border-color: var(--green);
      background: rgba(76, 175, 80, 0.1);
    }

    .not-host-msg {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    /* Footer */
    .game-footer {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 24px;
    }

    .quit-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .quit-btn:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    /* ============================================
       RESPONSIV
       ============================================ */

    @media (max-width: 600px) {
      .tableau {
        gap: 8px;
      }

      .suit-column {
        padding: 8px 4px;
        min-width: 50px;
      }

      .card-stack-upper,
      .card-stack-lower {
        height: 58px;
      }

      .card-stack-seven {
        height: 58px;
      }

      .table-card,
      .card-placeholder {
        width: 38px;
        height: 54px;
      }

      .table-card .rank { font-size: 0.85rem; }
      .table-card .suit { font-size: 0.95rem; }

      .card {
        width: 44px;
        height: 62px;
      }

      .card-back {
        width: 26px;
        height: 38px;
      }

      .hidden-hand .card-back {
        margin-left: -6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Meny-sk√§rm -->
    <div class="screen active" id="menuScreen">
      <div class="menu-card">
        <img src="gfx/asken_logo.webp" alt="ASKEN" class="game-logo">
        <div id="menuError" class="error-msg" style="display: none;"></div>
        <div class="form-row">
          <div class="form-group">
            <label>Ditt namn</label>
            <input type="text" id="playerName" placeholder="Namn" maxlength="20">
          </div>
          <div class="form-group">
            <label>Rumskod</label>
            <input type="text" id="roomCode" class="code-input" placeholder="XXXX" maxlength="4" oninput="updateMainButton()">
          </div>
        </div>
        <button class="btn btn-primary" id="mainActionBtn" onclick="mainAction()">Skapa nytt rum</button>
        <button class="btn btn-secondary" id="findPlayersBtn" onclick="findPlayers()">üîç Hitta andra spelare</button>
        <div class="footer-links">
          <a href="manual.html" class="rules-link">Spelregler</a>
          <span class="rules-link" style="cursor: default; margin: 0 8px;">‚Ä¢</span>
          <a href="about.html" class="rules-link">Om projektet</a>
        </div>
        
        <!-- Dela spelet -->
        <div class="share-section">
          <div class="share-title">Dela spelet</div>
          <div class="share-buttons">
            <button onclick="shareToFacebook()" title="Dela p√• Facebook" class="share-btn">
              <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="fbGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#0062E0"/>
                    <stop offset="100%" style="stop-color:#19AFFF"/>
                  </linearGradient>
                </defs>
                <path fill="url(#fbGradient)" d="M16.7,39.8C7.2,38.1,0,29.9,0,20C0,9,9,0,20,0s20,9,20,20c0,9.9-7.2,18.1-16.7,19.8H16.7z"/>
                <path fill="#FFFFFF" d="M27.8,25.6l0.9-5.6h-5.3v-3.9c0-1.6,0.6-2.8,3-2.8H29V8.2c-1.4-0.2-3-0.4-4.4-0.4c-4.6,0-7.8,2.8-7.8,7.8V20h-5v5.6h5v14.1c1.1,0.2,2.2,0.3,3.3,0.3c1.1,0,2.2-0.1,3.3-0.3V25.6H27.8z"/>
              </svg>
            </button>
            <button onclick="shareToTwitter()" title="Dela p√• X" class="share-btn">
              <svg viewBox="0 0 300 271" xmlns="http://www.w3.org/2000/svg">
                <path fill="#ffffff" d="m236 0h46l-101 115 118 156h-92.6l-72.5-94.8-83 94.8h-46l107-123-113-148h94.9l65.5 86.6zm-16.1 244h25.5l-165-218h-27.4z"/>
              </svg>
            </button>
            <button onclick="shareToLinkedIn()" title="Dela p√• LinkedIn" class="share-btn">
              <svg viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg">
                <path fill="#007EBB" d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z"/>
                <path fill="#FFF" d="M62,62 L51.315625,62 L51.315625,43.8021149 C51.315625,38.8127542 49.4197917,36.0245323 45.4707031,36.0245323 C41.1746094,36.0245323 38.9300781,38.9261103 38.9300781,43.8021149 L38.9300781,62 L28.6333333,62 L28.6333333,27.3333333 L38.9300781,27.3333333 L38.9300781,32.0029283 C38.9300781,32.0029283 42.0260417,26.2742151 49.3825521,26.2742151 C56.7356771,26.2742151 62,30.7644705 62,40.051212 L62,62 Z M16.349349,22.7940133 C12.8420573,22.7940133 10,19.9296567 10,16.3970067 C10,12.8643566 12.8420573,10 16.349349,10 C19.8566406,10 22.6970052,12.8643566 22.6970052,16.3970067 C22.6970052,19.9296567 19.8566406,22.7940133 16.349349,22.7940133 Z M11.0325521,62 L21.769401,62 L21.769401,27.3333333 L11.0325521,27.3333333 L11.0325521,62 Z"/>
              </svg>
            </button>
            <button onclick="shareToReddit()" title="Dela p√• Reddit" class="share-btn">
              <svg viewBox="0 0 824.9 810" xmlns="http://www.w3.org/2000/svg">
                <circle fill="#FF4500" cx="406.6" cy="405.6" r="402.3"/>
                <path fill="#FFFFFF" d="M674.9,405.6c-1.2-32.4-28.4-57.7-60.9-56.6c-14.4,0.5-28.1,6.4-38.5,16.3c-45.8-31.2-99.6-48.3-154.9-49.5l26.1-125.5l86.1,18.1c2.4,22.1,22.2,38.1,44.3,35.7c22.1-2.4,38.1-22.2,35.7-44.3s-22.2-38.1-44.3-35.7c-12.7,1.3-24.1,8.7-30.4,19.7l-98.6-19.7c-6.7-1.5-13.4,2.7-14.9,9.5c0,0.1,0,0.1,0,0.2l-29.7,139.6c-56,0.9-110.5,18.1-156.9,49.5c-23.6-22.2-60.8-21.1-83,2.6c-22.2,23.6-21.1,60.8,2.6,83c4.6,4.3,9.9,8,15.8,10.6c-0.4,5.9-0.4,11.8,0,17.7c0,90.1,105,163.4,234.5,163.4S642.4,567,642.4,476.8c0.4-5.9,0.4-11.8,0-17.7C662.6,449,675.3,428.2,674.9,405.6z M272.6,445.9c0-22.2,18.1-40.3,40.3-40.3s40.3,18.1,40.3,40.3c0,22.2-18.1,40.3-40.3,40.3C290.6,486,272.6,468.1,272.6,445.9z M506.3,556.5c-28.6,21.5-63.6,32.5-99.4,31c-35.8,1.5-70.8-9.5-99.4-31c-3.8-4.6-3.1-11.5,1.5-15.3c4-3.3,9.7-3.3,13.8,0c24.2,17.7,53.7,26.7,83.7,25.3c30,1.6,59.6-7,84.1-24.5c4.4-4.3,11.6-4.2,15.9,0.2s4.2,11.6-0.2,15.9l0,0V556.5L506.3,556.5z M499.1,487.6c-22.2,0-40.3-18.1-40.3-40.3c0-22.2,18.1-40.3,40.3-40.3s40.3,18.1,40.3,40.3c0.9,22.2-16.4,40.9-38.6,41.8c-0.7,0-1.3,0-2,0L499.1,487.6z"/>
              </svg>
            </button>
            <button onclick="shareToWhatsApp()" title="Dela p√• WhatsApp" class="share-btn">
              <svg viewBox="0 0 175.216 175.552" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="whatsappGradient" x1="85.915" x2="86.535" y1="32.567" y2="137.092" gradientUnits="userSpaceOnUse">
                    <stop offset="0" stop-color="#57d163"/>
                    <stop offset="1" stop-color="#23b33a"/>
                  </linearGradient>
                </defs>
                <path fill="#fff" d="m12.966 161.238 10.439-38.114a73.42 73.42 0 0 1-9.821-36.772c.017-40.556 33.021-73.55 73.578-73.55 19.681.01 38.154 7.669 52.047 21.572s21.537 32.383 21.53 52.037c-.018 40.553-33.027 73.553-73.578 73.553h-.032c-12.313-.005-24.412-3.094-35.159-8.954z"/>
                <path fill="url(#whatsappGradient)" d="M87.184 25.227c-33.733 0-61.166 27.423-61.178 61.13a60.98 60.98 0 0 0 9.349 32.535l1.455 2.313-6.179 22.558 23.146-6.069 2.235 1.324c9.387 5.571 20.15 8.517 31.126 8.523h.023c33.707 0 61.14-27.426 61.153-61.135a60.75 60.75 0 0 0-17.895-43.251 60.75 60.75 0 0 0-43.235-17.928z"/>
                <path fill="#fff" fill-rule="evenodd" d="M68.772 55.603c-1.378-3.061-2.828-3.123-4.137-3.176l-3.524-.043c-1.226 0-3.218.46-4.902 2.3s-6.435 6.287-6.435 15.332 6.588 17.785 7.506 19.013 12.718 20.381 31.405 27.75c15.529 6.124 18.689 4.906 22.061 4.6s10.877-4.447 12.408-8.74 1.532-7.971 1.073-8.74-1.685-1.226-3.525-2.146-10.877-5.367-12.562-5.981-2.91-.919-4.137.921-4.746 5.979-5.819 7.206-2.144 1.381-3.984.462-7.76-2.861-14.784-9.124c-5.465-4.873-9.154-10.891-10.228-12.73s-.114-2.835.808-3.751c.825-.824 1.838-2.147 2.759-3.22s1.224-1.84 1.836-3.065.307-2.301-.153-3.22-4.032-10.011-5.666-13.647"/>
              </svg>
            </button>
            <button onclick="shareViaEmail()" title="Dela via e-post" class="share-btn">
              <svg viewBox="0 0 975.9 800" xmlns="http://www.w3.org/2000/svg">
                <path fill="#ffffff" d="M104.3,627.5c-9.2,0-17.8-2.4-25.2-6.7l217.3-189.3l20.3,17.6c17,14.8,38.2,22.2,59.3,22.2c21.1,0,42.4-7.5,59.4-22.2l20.3-17.6l73.6,64.1c8.3-14,18.7-26.6,30.6-37.6l-67.3-58.7l206-179.7v198.6c19.2,3.5,37.1,10.3,53.3,19.9v-243c0-6.9-0.7-13.7-1.9-20.3c-3.4-17.1-11-32.7-21.5-45.6c-2.2-2.8-4.6-5.3-7.1-7.8c-18.7-18.8-45-30.6-73.7-30.6H104.3c-28.7,0-54.9,11.7-73.7,30.6c-2.5,2.5-4.8,5-7.1,7.8C12.9,142.1,5.3,157.7,2,174.8c-1.4,6.6-2,13.4-2,20.3v381.5c0,14.6,3.1,28.7,8.6,41.4c5.1,12.1,12.7,23.1,21.9,32.3c2.3,2.3,4.7,4.5,7.2,6.6c18,14.9,41.3,24,66.5,24h438.3c-12.7-15.7-22.6-33.7-28.8-53.4L104.3,627.5L104.3,627.5z M68.3,159.1c9.3-9.3,21.8-14.9,36-14.9h543.2c14.2,0,26.8,5.6,36,14.9c1.6,1.7,3.2,3.5,4.6,5.3L403.3,412.5c-7.9,6.9-17.6,10.3-27.5,10.3c-9.8,0-19.5-3.4-27.5-10.3L63.8,164.3C65.1,162.5,66.6,160.7,68.3,159.1z M53.3,576.6V219.5l206,179.7L53.4,578.8C53.3,578.1,53.3,577.3,53.3,576.6z"/>
                <path fill="#ffffff" d="M764.6,593.3c-4.6,4.6-63.3,63.3-63.3,63.3c-4.9,4.9-11.4,7.4-17.9,7.4c-6.5,0-13-2.5-17.9-7.4c-9.9-9.9-9.9-25.9,0-35.8l20.1-20.1H569.5c-14,0-25.3-11.3-25.3-25.3s11.3-25.3,25.3-25.3h116.1l-20.1-20.1c-9.9-9.9-9.9-25.9,0-35.8c9.9-9.9,25.9-9.9,35.8,0c0,0,58.1,58.1,63.3,63.3s0,0,0.1,0.1c0,0,0.1,0.1,0.1,0.1c0.4,0.3,0.7,0.7,1.1,1c0,0,0,0,0,0.1c0.2,0.2,0.5,0.5,0.7,0.7C433.9,505.4,433.1,445,395.6,407.4z"/>
              </svg>
            </button>
            <button onclick="copyGameLink()" title="Kopiera l√§nk" class="share-btn">
              <svg viewBox="0 0 800 800" xmlns="http://www.w3.org/2000/svg">
                <path fill="#ffffff" d="M683.3,33.3H250c-46,0-83.3,37.4-83.3,83.3v16.7h-50c-45.9,0-83.3,37.4-83.3,83.3v466.7c0,46,37.4,83.3,83.3,83.3h466.7c46,0,83.3-37.4,83.3-83.3v-50h16.7c46,0,83.3-37.4,83.3-83.3V116.7C766.7,70.7,729.3,33.3,683.3,33.3z M600,683.3c0,9.2-7.5,16.7-16.7,16.7H116.7c-9.2,0-16.7-7.5-16.7-16.7V216.7c0-9.2,7.5-16.7,16.7-16.7h466.7c9.2,0,16.7,7.5,16.7,16.7V683.3z M700,550c0,9.2-7.5,16.7-16.7,16.7h-16.7v-350c0-45.9-37.4-83.3-83.3-83.3h-350v-16.7c0-9.2,7.5-16.7,16.7-16.7h433.3c9.2,0,16.7,7.5,16.7,16.7V550z"/>
                <path fill="#ffffff" d="M507.9,271c-18.2-18.2-42.3-28.4-67.8-28.7c-25.8-0.3-50.1,9.4-68.2,27.6c-0.2,0.2-0.3,0.3-0.5,0.5l-88.2,91.8c-2.1,2.2-3.8,4.5-5.2,7c-13.8,18.1-20.7,40.8-19.2,64c1.6,23.5,11.7,45.7,28.5,62.5c6.5,6.5,15,9.8,23.6,9.8s17.1-3.3,23.6-9.8c13-13,13-34.1,0-47.1c-5.4-5.4-8.7-12.5-9.2-19.9c-0.6-8.3,2.3-16.1,8-21.8c1.6-1.6,3.1-3.4,4.3-5.3l81.6-84.9c5.3-5.2,12.4-8,19.9-7.8c8,0.1,15.7,3.4,21.5,9.2c11.8,11.8,12.3,30.5,1.2,41.7c-0.2,0.2-0.4,0.5-0.7,0.7l-31.8,33.7c-12.6,13.4-12,34.5,1.3,47.1c6.4,6.1,14.7,9.1,22.9,9.1c8.9,0,17.7-3.5,24.2-10.4l31.5-33.4C546.2,369.3,545.6,308.6,507.9,271z"/>
                <path fill="#ffffff" d="M395.6,407.4c-13-13-34.1-13-47.1,0c-13,13-13,34.1,0,47.1c11.7,11.7,12.3,30.1,1.6,41.3l-85.3,77.4c-0.4,0.4-0.8,0.7-1.2,1.1c-11.2,11.2-29.8,10.6-41.7-1.2c-11.5-11.5-11.6-33.2-0.2-44.9c2.3-2.2,18.1-17.5,26.3-25.7c13-13,13-34.1,0-47.1c-13-13-34.1-13-47.1,0c-8.2,8.2-25.5,24.9-25.7,25.1c-0.1,0.1-0.3,0.3-0.4,0.4c-17.8,17.8-28,43-28.2,69.2c-0.1,26.5,10.1,52,28.2,70.1c19.1,19.1,44.2,28.7,69.1,28.7c24,0,48-8.9,66.2-26.9l85.4-77.5c0,0,0.1-0.1,0.1-0.1l0,0c0,0,0.1-0.1,0.1-0.1c0.4-0.3,0.7-0.7,1.1-1c0,0,0,0,0-0.1c0.2-0.2,0.5-0.5,0.7-0.7C433.9,505.4,433.1,445,395.6,407.4z"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="credit-link">
          Skapat av <a href="https://patrikpistol.com" target="_blank">Patrik Pistol</a> f√∂r <a href="https://pistol.se" target="_blank">Pistol Reklambyr√• AB</a>
        </div>
      </div>
    </div>

    <!-- Matchmaking-sk√§rm -->
    <div class="screen" id="matchmakingScreen">
      <div class="lobby-card">
        <h2>üîç S√∂ker spelare...</h2>
        <div class="matchmaking-info">
          <div class="matchmaking-spinner"></div>
          <p id="matchmakingStatus">Letar efter andra spelare som vill spela</p>
          <p class="matchmaking-queue">Spelare i k√∂: <span id="queueCount">1</span></p>
          <p class="matchmaking-position">Din plats i k√∂n: <span id="queuePosition">1</span></p>
        </div>
        <div class="player-list" id="matchmakingPlayerList"></div>
        <div id="matchmakingControls" style="display: none;">
          <p class="host-notice">Alla kan starta spelet!</p>
          <button class="btn btn-primary" onclick="startMatchmakingGame()">Starta spel</button>
        </div>
        <button class="btn btn-secondary" onclick="leaveMatchmaking()">Avbryt s√∂kning</button>
      </div>
    </div>

    <!-- Lobby-sk√§rm -->
    <div class="screen" id="lobbyScreen">
      <div class="lobby-card">
        <h2>V√§ntar p√• spelare...</h2>
        <div class="room-code-label">Rumskod</div>
        <div class="room-code-container">
          <div class="room-code" id="displayRoomCode">XXXX</div>
        </div>
        <div class="lobby-actions">
          <button class="invite-btn" onclick="showInviteModal()">Bjud in v√§n</button>
          <button class="invite-btn" id="copyCodeBtn" onclick="copyRoomCode()">Kopiera rumskod</button>
        </div>
        <div class="player-list" id="lobbyPlayerList"></div>
        <div id="botButtonContainer"></div>
        <div id="botDifficultyContainer" style="display: none;">
          <div class="difficulty-label">Robotarnas intelligens</div>
          <div class="difficulty-selector">
            <button class="difficulty-btn active" data-difficulty="dumb" onclick="setBotDifficulty('dumb')">
              Dum
            </button>
            <button class="difficulty-btn" data-difficulty="medium" onclick="setBotDifficulty('medium')">
              Medel
            </button>
            <button class="difficulty-btn" data-difficulty="smart" onclick="setBotDifficulty('smart')">
              Smart
            </button>
          </div>
        </div>
        <div id="helpModeContainer" style="display: none;">
          <div class="help-mode-toggle">
            <label class="toggle-label">
              <input type="checkbox" id="helpModeCheckbox" onchange="toggleHelpMode()">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Visa spelbar hj√§lp</span>
            </label>
            <div class="help-mode-desc" id="helpModeDesc">Av - Du m√•ste t√§nka sj√§lv!</div>
          </div>
        </div>
        <div class="waiting-text" id="waitingText">Minst 3 spelare kr√§vs f√∂r att starta</div>
        
        <div id="hostControls" style="display: none;">
          <div class="start-buttons">
            <button class="start-btn" id="startQuickBtn" onclick="startGame('quick')" disabled>
              Spela snabbspel
              <span>En runda</span>
            </button>
            <button class="start-btn" id="startStandardBtn" onclick="startGame('standard')" disabled>
              Spela standardspel
              <span>Till 500 po√§ng</span>
            </button>
          </div>
        </div>
        
        <button class="btn btn-secondary" onclick="leaveRoom()">L√§mna rum</button>
      </div>
    </div>

    <!-- Spel-sk√§rm -->
    <div class="screen" id="gameScreen">
      <div id="gameError" class="error-msg game-error" style="display: none;"></div>
      
      <!-- Chat-knapp -->
      <button class="chat-toggle" id="chatToggle" onclick="openChat()" title="√ñppna chatt">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
          <path d="M7 9h10v2H7zm0-3h10v2H7z"/>
        </svg>
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
      </button>
      
      <div class="tableau-container">
        <div class="tableau-title" id="tableauTitle">RUNDA 1 ‚Ä¢ INGEN HAR ASKEN</div>
        <div class="tableau" id="tableau"></div>
      </div>

      <div class="players-area" id="playersArea"></div>

      <div class="game-footer" id="gameFooter">
        <button class="quit-btn" onclick="leaveRoom()">L√§mna spel</button>
      </div>
    </div>
    
    <!-- Chat-modal -->
    <div class="chat-modal" id="chatModal">
      <div class="chat-container">
        <div class="chat-header">
          <h3>üí¨ Chatt</h3>
          <button class="chat-close" onclick="closeChat()">‚úï</button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="chat-empty">Inga meddelanden √§n. S√§g hej!</div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="chatInput" placeholder="Skriv ett meddelande..." maxlength="200" onkeypress="handleChatKeypress(event)">
          <button class="chat-send-btn" onclick="sendChatMessage()">Skicka</button>
        </div>
      </div>
    </div>

    <!-- Resultat-modal -->
    <div class="modal-overlay" id="modal" onclick="handleModalClick(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <h2 id="modalTitle">Runda slut!</h2>
        <div class="winner" id="modalWinner"></div>
        <table class="score-table" id="scoreTable">
          <thead>
            <tr>
              <th>Spelare</th>
              <th>Kort</th>
              <th>Po√§ng</th>
              <th>Asken</th>
              <th>Totalt</th>
            </tr>
          </thead>
          <tbody id="scoreBody"></tbody>
        </table>
        <div class="modal-buttons" id="modalButtons"></div>
        <p class="modal-hint">Klicka utanf√∂r f√∂r att se spelplanen</p>
      </div>
    </div>
    
    <!-- Inbjudningsmodal -->
    <div class="modal-overlay" id="inviteModal" onclick="closeInviteModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <h2>Bjud in v√§n</h2>
        <div class="form-group" style="text-align: left; margin-top: 16px;">
          <label>V√§nnens namn</label>
          <input type="text" id="inviteName" placeholder="Ange namn" maxlength="20">
        </div>
        <div id="inviteLinkContainer" style="display: none;">
          <div class="invite-link-label">Inbjudningsl√§nk</div>
          <div class="invite-link-box" id="inviteLinkBox"></div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn" id="generateLinkBtn" onclick="generateInviteLink()">Skapa l√§nk</button>
          <button class="modal-btn secondary" onclick="closeInviteModal()">St√§ng</button>
        </div>
      </div>
    </div>
    
    <!-- Ogiltigt drag modal -->
    <div class="invalid-modal" id="invalidMoveModal">
      <div class="invalid-modal-content">
        <div class="invalid-modal-title">‚ùå Ogiltigt drag</div>
        <div class="invalid-modal-message" id="invalidMoveMessage"></div>
        <button class="invalid-modal-btn" id="invalidMoveBtn" onclick="closeInvalidModal()" disabled>OK</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // KONSTANTER
    // ============================================

    const SUITS = ['spades', 'hearts', 'clubs', 'diamonds'];
    const SUIT_SYMBOLS = { spades: '‚ô†', hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£' };
    const SUIT_COLORS = { spades: 'black', hearts: 'red', diamonds: 'red', clubs: 'black' };
    const RANK_NAMES = { 
      1: 'A', 2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 
      8: '8', 9: '9', 10: '10', 11: 'J', 12: 'Q', 13: 'K' 
    };

    // ============================================
    // STATE
    // ============================================

    let socket = null;
    let gameState = null;
    let selectedCardIds = [];
    
    // F√∂r reconnect - anv√§nd sessionStorage f√∂r att √∂verleva siduppdatering
    let currentRoomCode = sessionStorage.getItem('asken_roomCode') || null;
    let currentPlayerName = sessionStorage.getItem('asken_playerName') || null;
    let keepaliveInterval = null;
    
    // Hj√§lpfunktioner f√∂r att spara/rensa session
    function saveSession(code, name) {
      currentRoomCode = code;
      currentPlayerName = name;
      if (code && name) {
        sessionStorage.setItem('asken_roomCode', code);
        sessionStorage.setItem('asken_playerName', name);
      }
    }
    
    function clearSession() {
      currentRoomCode = null;
      currentPlayerName = null;
      sessionStorage.removeItem('asken_roomCode');
      sessionStorage.removeItem('asken_playerName');
    }

    // ============================================
    // SOCKET ANSLUTNING
    // ============================================

    function connectSocket() {
      socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,  // Forts√§tt f√∂rs√∂ka
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        timeout: 45000,
        forceNew: false,
        transports: ['websocket', 'polling']  // Prioritera websocket
      });

      socket.on('connect', () => {
        console.log('Ansluten till server, socket.id:', socket.id);
        hideError(); // Ta bort eventuellt felmeddelande
        
        // F√∂rs√∂k √•teransluta till rum om vi var i ett
        if (currentRoomCode && currentPlayerName) {
          console.log('F√∂rs√∂ker √•teransluta till rum:', currentRoomCode);
          socket.emit('rejoinRoom', { 
            code: currentRoomCode, 
            name: currentPlayerName 
          });
        }
        
        // Starta keepalive-ping var 20:e sekund
        if (keepaliveInterval) clearInterval(keepaliveInterval);
        keepaliveInterval = setInterval(() => {
          if (socket && socket.connected && currentRoomCode) {
            socket.emit('ping');
          }
        }, 20000);
      });

      socket.on('roomCreated', ({ code }) => {
        saveSession(code, document.getElementById('playerName').value.trim());
        document.getElementById('displayRoomCode').textContent = code;
        showScreen('lobbyScreen');
      });

      socket.on('roomJoined', ({ code }) => {
        saveSession(code, document.getElementById('playerName').value.trim());
        document.getElementById('displayRoomCode').textContent = code;
        showScreen('lobbyScreen');
      });
      
      // Matchmaking events
      socket.on('matchmakingUpdate', (state) => {
        renderMatchmakingState(state);
      });
      
      socket.on('matchmakingGameStarted', ({ code, playerName }) => {
        const name = playerName || document.getElementById('playerName').value.trim();
        saveSession(code, name);
        document.getElementById('displayRoomCode').textContent = code;
        
        // Bekr√§fta till servern att vi g√•tt med i rummet
        socket.emit('confirmMatchmakingJoin', code);
        
        showScreen('lobbyScreen');
      });
      
      socket.on('rejoinSuccess', ({ code }) => {
        saveSession(code, currentPlayerName);
        document.getElementById('displayRoomCode').textContent = code;
        console.log('√Öteransluten till rum:', code);
      });
      
      socket.on('rejoinFailed', ({ message }) => {
        console.log('Kunde inte √•teransluta:', message);
        clearSession();
        showScreen('menuScreen');
        showError('Rummet finns inte l√§ngre. Skapa ett nytt.');
      });

      socket.on('gameState', (state) => {
        gameState = state;
        saveSession(state.code, currentPlayerName);
        selectedCardIds = [];
        render();
      });

      socket.on('cardsSelected', (cardIds) => {
        selectedCardIds = cardIds;
        render();
      });

      socket.on('error', ({ message }) => {
        showError(message);
      });
      
      // Chat-meddelande
      socket.on('chatMessage', (data) => {
        addChatMessage(data);
      });
      
      // Ogiltigt drag (n√§r hj√§lpl√§ge √§r av)
      socket.on('invalidMove', ({ message }) => {
        showInvalidMoveModal(message);
      });
      
      // N√§r spelet avbryts av en annan spelare
      socket.on('gameEnded', ({ playerName, reason }) => {
        document.getElementById('modal').classList.remove('visible');
        gameState = null;
        selectedCardIds = [];
        clearSession();
        showScreen('menuScreen');
        showError(`Spelet avslutades: ${playerName} har l√§mnat spelet`);
      });
      
      socket.on('hostEndedGame', () => {
        document.getElementById('modal').classList.remove('visible');
        gameState = null;
        selectedCardIds = [];
        clearSession();
        showScreen('menuScreen');
        showError('V√§rden har avslutat spelet');
      });
      
      // N√§r v√§rden startar n√§sta runda - st√§ng modal f√∂r alla
      socket.on('closeModal', () => {
        document.getElementById('modal').classList.remove('visible');
      });

      socket.on('disconnect', (reason) => {
        console.log('Fr√•nkopplad fr√•n server:', reason);
        
        // Rensa keepalive
        if (keepaliveInterval) {
          clearInterval(keepaliveInterval);
          keepaliveInterval = null;
        }
        
        // Visa meddelande baserat p√• orsak
        if (reason === 'io server disconnect') {
          // Servern st√§ngde anslutningen
          showError('Servern avslutade anslutningen - f√∂rs√∂ker √•teransluta...');
        } else if (reason === 'transport close' || reason === 'ping timeout') {
          showError('Tappad anslutning - f√∂rs√∂ker √•teransluta...');
        } else if (reason !== 'io client disconnect') {
          showError('Anslutningen avbr√∂ts - f√∂rs√∂ker √•teransluta...');
        }
      });
      
      socket.on('reconnect', (attemptNumber) => {
        console.log('√Öteransluten efter', attemptNumber, 'f√∂rs√∂k');
        hideError();
        
        // Socket.io har √•teranslutit, men vi beh√∂ver rejoin:a rummet
        // Detta hanteras automatiskt i 'connect'-eventet
      });
      
      socket.on('reconnect_attempt', (attemptNumber) => {
        if (attemptNumber > 3) {
          showError(`√Öteranslutningsf√∂rs√∂k ${attemptNumber}...`);
        }
      });
      
      socket.on('reconnect_error', (error) => {
        console.log('√Öteranslutningsfel:', error.message);
      });
      
      socket.on('reconnect_failed', () => {
        // Beh√•ll session s√• anv√§ndaren kan ladda om och f√∂rs√∂ka igen
        showScreen('menuScreen');
        showError('Kunde inte √•teransluta till servern. Ladda om sidan och f√∂rs√∂k igen.');
      });
    }

    // ============================================
    // SK√ÑRM-HANTERING
    // ============================================

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function showError(message) {
      // Visa p√• spelsk√§rmen om vi √§r d√§r, annars p√• menyn
      const gameScreen = document.getElementById('gameScreen');
      const isInGame = gameScreen.classList.contains('active');
      
      const errorEl = document.getElementById(isInGame ? 'gameError' : 'menuError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      
      // √Öterst√§ll animation
      errorEl.style.animation = 'none';
      errorEl.offsetHeight; // Trigger reflow
      errorEl.style.animation = null;
      
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 6000);
    }
    
    function hideError() {
      document.getElementById('gameError').style.display = 'none';
      document.getElementById('menuError').style.display = 'none';
    }

    // ============================================
    // MENY-FUNKTIONER
    // ============================================

    function updateMainButton() {
      const code = document.getElementById('roomCode').value.trim();
      const btn = document.getElementById('mainActionBtn');
      if (code.length > 0) {
        btn.textContent = 'G√• med i rum';
      } else {
        btn.textContent = 'Skapa nytt rum';
      }
    }
    
    function mainAction() {
      const code = document.getElementById('roomCode').value.trim();
      if (code.length > 0) {
        joinRoom();
      } else {
        createRoom();
      }
    }
    
    // ============================================
    // MATCHMAKING
    // ============================================
    
    function findPlayers() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) {
        showError('Ange ditt namn');
        return;
      }
      
      if (!socket) connectSocket();
      socket.emit('joinMatchmaking', name);
      showScreen('matchmakingScreen');
    }
    
    function leaveMatchmaking() {
      if (socket) {
        socket.emit('leaveMatchmaking');
      }
      showScreen('menuScreen');
    }
    
    function startMatchmakingGame() {
      if (socket) {
        socket.emit('startMatchmakingGame');
      }
    }
    
    function renderMatchmakingState(state) {
      // Uppdatera k√∂info
      document.getElementById('queueCount').textContent = state.queueCount;
      document.getElementById('queuePosition').textContent = state.position;
      
      // Visa starta-knappen f√∂r alla n√§r det finns minst 2 spelare
      const controls = document.getElementById('matchmakingControls');
      if (state.queueCount >= 2) {
        controls.style.display = 'block';
      } else {
        controls.style.display = 'none';
      }
      
      // Uppdatera statusmeddelande
      const status = document.getElementById('matchmakingStatus');
      if (state.queueCount === 1) {
        status.textContent = 'V√§ntar p√• fler spelare...';
      } else {
        status.textContent = `${state.queueCount} spelare redo! Vem som helst kan starta.`;
      }
      
      // Rendera spelarlista (ta bort v√§rd-markering)
      const list = document.getElementById('matchmakingPlayerList');
      list.innerHTML = state.players.map(p => `
        <div class="player-item">
          <span class="player-name">${p.name}</span>
          <span class="player-status">Plats ${p.position}</span>
        </div>
      `).join('');
    }

    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) {
        showError('Ange ditt namn');
        return;
      }
      if (!socket) connectSocket();
      socket.emit('createRoom', name);
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const code = document.getElementById('roomCode').value.trim().toUpperCase();
      
      if (!name) {
        showError('Ange ditt namn');
        return;
      }
      if (!code || code.length !== 4) {
        showError('Ange en giltig rumskod (4 tecken)');
        return;
      }
      
      if (!socket) connectSocket();
      socket.emit('joinRoom', { code, name });
    }

    function leaveRoom() {
      if (socket) {
        socket.emit('leaveRoom');
      }
      gameState = null;
      selectedCardIds = [];
      clearChat();
      clearSession();
      showScreen('menuScreen');
    }
    
    function hostEndGame() {
      if (socket) {
        socket.emit('hostEndGame');
      }
      document.getElementById('modal').classList.remove('visible');
      gameState = null;
      selectedCardIds = [];
      clearChat();
      clearSession();
      showScreen('menuScreen');
    }
    
    function addBot() {
      if (socket) {
        socket.emit('addBot');
      }
    }
    
    function removeBot(botId) {
      if (socket) {
        socket.emit('removeBot', botId);
      }
    }
    
    function copyRoomCode() {
      const code = document.getElementById('displayRoomCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById('copyCodeBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Kopierad!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      });
    }
    
    function showInviteModal() {
      document.getElementById('inviteName').value = '';
      document.getElementById('inviteLinkContainer').style.display = 'none';
      document.getElementById('inviteLinkBox').textContent = '';
      document.getElementById('inviteLinkBox').classList.remove('copied');
      const btn = document.getElementById('generateLinkBtn');
      btn.textContent = 'Skapa l√§nk';
      btn.onclick = generateInviteLink;
      document.getElementById('inviteModal').classList.add('visible');
    }
    
    function closeInviteModal() {
      document.getElementById('inviteModal').classList.remove('visible');
    }
    
    function generateInviteLink() {
      const name = document.getElementById('inviteName').value.trim();
      if (!name) {
        document.getElementById('inviteName').focus();
        return;
      }
      
      const code = document.getElementById('displayRoomCode').textContent;
      const baseUrl = window.location.origin + window.location.pathname;
      const link = `${baseUrl}?namn=${encodeURIComponent(name)}&rum=${code}`;
      
      const linkBox = document.getElementById('inviteLinkBox');
      linkBox.textContent = link;
      linkBox.onclick = function() { copyInviteLink(link); };
      document.getElementById('inviteLinkContainer').style.display = 'block';
      document.getElementById('generateLinkBtn').textContent = 'Kopiera l√§nk';
      document.getElementById('generateLinkBtn').onclick = function() {
        copyInviteLink(link);
      };
    }
    
    function copyInviteLink(link) {
      navigator.clipboard.writeText(link).then(() => {
        const linkBox = document.getElementById('inviteLinkBox');
        linkBox.classList.add('copied');
        document.getElementById('generateLinkBtn').textContent = 'Kopierad!';
        setTimeout(() => {
          linkBox.classList.remove('copied');
          document.getElementById('generateLinkBtn').textContent = 'Kopiera l√§nk';
        }, 2000);
      });
    }
    
    function setBotDifficulty(difficulty) {
      if (socket) {
        socket.emit('setBotDifficulty', difficulty);
      }
      // Uppdatera knapparna lokalt direkt f√∂r snabbare respons
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.difficulty === difficulty);
      });
    }
    
    function toggleHelpMode() {
      const checkbox = document.getElementById('helpModeCheckbox');
      const helpMode = checkbox.checked;
      
      if (socket) {
        socket.emit('setHelpMode', helpMode);
      }
      
      // Uppdatera beskrivning lokalt
      const desc = document.getElementById('helpModeDesc');
      desc.textContent = helpMode ? 'P√• - Spelbara kort markeras' : 'Av - Du m√•ste t√§nka sj√§lv!';
    }
    
    let invalidModalTimeout = null;
    
    function showInvalidMoveModal(message) {
      const modal = document.getElementById('invalidMoveModal');
      const msgEl = document.getElementById('invalidMoveMessage');
      const btn = document.getElementById('invalidMoveBtn');
      
      msgEl.innerHTML = message;
      btn.disabled = true;
      modal.classList.add('visible');
      
      // Aktivera knappen efter 1.5 sekunder
      if (invalidModalTimeout) clearTimeout(invalidModalTimeout);
      invalidModalTimeout = setTimeout(() => {
        btn.disabled = false;
      }, 1500);
    }
    
    function closeInvalidModal() {
      const btn = document.getElementById('invalidMoveBtn');
      if (btn.disabled) return; // Kan inte st√§ngas √§n
      
      document.getElementById('invalidMoveModal').classList.remove('visible');
      if (invalidModalTimeout) {
        clearTimeout(invalidModalTimeout);
        invalidModalTimeout = null;
      }
    }

    function startGame(mode) {
      socket.emit('startGame', mode);
    }

    // ============================================
    // SPELLOGIK
    // ============================================

    function toggleCard(cardId) {
      if (!gameState || gameState.roundEnded) return;
      
      const me = gameState.players.find(p => p.isMe);
      if (!me || !me.isCurrent) return;
      
      // Om hj√§lpl√§ge √§r p√•, kolla om kortet √§r spelbart
      // Om hj√§lpl√§ge √§r av, till√•t alla kort
      if (gameState.helpMode && !gameState.playableCardIds?.includes(cardId)) return;
      
      const index = selectedCardIds.indexOf(cardId);
      if (index >= 0) {
        selectedCardIds.splice(index, 1);
      } else {
        selectedCardIds.push(cardId);
      }
      
      render();
    }

    function selectAllPlayable() {
      if (!gameState || gameState.roundEnded) return;
      if (!gameState.playableCardIds) return;
      
      selectedCardIds = [...gameState.playableCardIds];
      render();
    }

    function playCards() {
      if (selectedCardIds.length === 0) return;
      
      console.log('F√∂rs√∂ker spela kort:', selectedCardIds);
      console.log('Nuvarande tableau:', gameState.tableau);
      
      // Om hj√§lpl√§ge √§r p√•, validera p√• klientsidan f√∂rst
      // Om hj√§lpl√§ge √§r av, l√•t servern validera
      if (gameState.helpMode) {
        if (!validateSelectedCards()) {
          console.log('Klient-validering misslyckades');
          showError('Ogiltigt val - korten kan inte spelas tillsammans');
          return;
        }
        console.log('Klient-validering OK, skickar till server');
      }
      
      socket.emit('playCards', selectedCardIds);
      // Rensa INTE h√§r - v√§nta p√• gameState fr√•n servern
    }
    
    // Klient-validering av valda kort
    function validateSelectedCards() {
      if (selectedCardIds.length === 0) return false;
      if (!gameState || !gameState.tableau) return false;
      
      const me = gameState.players.find(p => p.isMe);
      if (!me || !me.hand) return false;
      
      const selectedCards = selectedCardIds
        .map(id => me.hand.find(c => c.id === id))
        .filter(Boolean);
      
      if (selectedCards.length !== selectedCardIds.length) return false;
      
      console.log('Validerar kort:', selectedCards.map(c => `${c.suit}-${c.rank}`));
      
      // Simulera getPlayableOrder
      const simTableau = {
        spades: gameState.tableau.spades ? { ...gameState.tableau.spades } : null,
        hearts: gameState.tableau.hearts ? { ...gameState.tableau.hearts } : null,
        clubs: gameState.tableau.clubs ? { ...gameState.tableau.clubs } : null,
        diamonds: gameState.tableau.diamonds ? { ...gameState.tableau.diamonds } : null
      };
      
      console.log('Startar med tableau:', JSON.stringify(simTableau));
      
      const remaining = [...selectedCards];
      
      while (remaining.length > 0) {
        let foundPlayable = false;
        
        for (let i = 0; i < remaining.length; i++) {
          const card = remaining[i];
          const canPlay = canPlayCardClient(card, simTableau);
          console.log(`Kan ${card.suit}-${card.rank} spelas?`, canPlay);
          
          if (canPlay) {
            remaining.splice(i, 1);
            
            if (!simTableau[card.suit]) {
              simTableau[card.suit] = { low: card.rank, high: card.rank };
            } else {
              if (card.rank < simTableau[card.suit].low) {
                simTableau[card.suit].low = card.rank;
              }
              if (card.rank > simTableau[card.suit].high) {
                simTableau[card.suit].high = card.rank;
              }
            }
            
            console.log('Uppdaterat tableau:', JSON.stringify(simTableau));
            foundPlayable = true;
            break;
          }
        }
        
        if (!foundPlayable) {
          console.log('Kunde inte hitta spelbart kort, kvar:', remaining.map(c => `${c.suit}-${c.rank}`));
          return false;
        }
      }
      
      console.log('Alla kort kan spelas!');
      return true;
    }
    
    function canPlayCardClient(card, tableau) {
      const anyCardPlayed = Object.values(tableau).some(s => s !== null);
      if (!anyCardPlayed) {
        return card.suit === 'spades' && card.rank === 7;
      }
      
      const suitState = tableau[card.suit];
      
      if (!suitState) {
        return card.rank === 7;
      }
      
      return card.rank === suitState.low - 1 || card.rank === suitState.high + 1;
    }

    function pass() {
      socket.emit('pass');
    }

    function nextRound() {
      socket.emit('nextRound');
      document.getElementById('modal').classList.remove('visible');
    }

    function newGame() {
      socket.emit('newGame');
      document.getElementById('modal').classList.remove('visible');
    }

    function handleModalClick(event) {
      if (event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('visible');
      }
    }

    // ============================================
    // RENDERING
    // ============================================

    function render() {
      if (!gameState) return;

      if (gameState.state === 'lobby') {
        renderLobby();
        showScreen('lobbyScreen');
      } else {
        renderGame();
        showScreen('gameScreen');
        
        if (gameState.roundEnded) {
          setTimeout(() => showResultModal(), 500);
        }
      }
    }

    function renderLobby() {
      const list = document.getElementById('lobbyPlayerList');
      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const hasBots = gameState.hasBots || gameState.players.some(p => p.isBot);
      
      list.innerHTML = gameState.players.map(p => `
        <div class="player-list-item ${p.isMe ? 'is-me' : ''} ${p.isBot ? 'is-bot' : ''}">
          <div class="player-avatar">${p.isBot ? 'ü§ñ' : p.name.charAt(0).toUpperCase()}</div>
          <div class="player-info">
            <div class="name">${p.name}${p.isMe ? ' (du)' : ''}</div>
            <div class="role">${p.isHost ? 'V√§rd' : (p.isBot ? 'Robot' : 'Spelare')}</div>
          </div>
          ${p.isHost ? '<span class="host-badge">V√ÑRD</span>' : ''}
          ${p.isBot && isHost ? `<button class="remove-bot-btn" onclick="removeBot('${p.id}')">‚úï</button>` : ''}
        </div>
      `).join('');

      const canStart = gameState.players.length >= 3;
      const canAddBot = gameState.players.length < 7;
      
      document.getElementById('hostControls').style.display = isHost ? 'block' : 'none';
      document.getElementById('startQuickBtn').disabled = !canStart;
      document.getElementById('startStandardBtn').disabled = !canStart;
      
      // Uppdatera robot-knappen
      const botBtnContainer = document.getElementById('botButtonContainer');
      if (botBtnContainer) {
        botBtnContainer.innerHTML = isHost && canAddBot ? `
          <button class="btn btn-secondary add-bot-btn" onclick="addBot()">
            ü§ñ L√§gg till robot
          </button>
        ` : '';
      }
      
      // Visa/g√∂m sv√•righetsgrad f√∂r robotar
      const difficultyContainer = document.getElementById('botDifficultyContainer');
      if (difficultyContainer) {
        difficultyContainer.style.display = (isHost && hasBots) ? 'block' : 'none';
        
        // Uppdatera aktiv knapp
        const currentDifficulty = gameState.botDifficulty || 'dumb';
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.difficulty === currentDifficulty);
        });
      }
      
      // Visa/g√∂m hj√§lpl√§ge-toggle (alltid synlig f√∂r v√§rd)
      const helpModeContainer = document.getElementById('helpModeContainer');
      if (helpModeContainer) {
        helpModeContainer.style.display = isHost ? 'block' : 'none';
        
        // Uppdatera checkbox och beskrivning
        const checkbox = document.getElementById('helpModeCheckbox');
        const desc = document.getElementById('helpModeDesc');
        const helpMode = gameState.helpMode || false;
        
        checkbox.checked = helpMode;
        desc.textContent = helpMode ? 'P√• - Spelbara kort markeras' : 'Av - Du m√•ste t√§nka sj√§lv!';
      }
      
      document.getElementById('waitingText').textContent = canStart 
        ? `${gameState.players.length} spelare redo`
        : `Minst 3 spelare kr√§vs (${gameState.players.length}/3)`;
    }

    function renderGame() {
      renderTableau();
      renderPlayers();
      renderInfo();
      renderGameFooter();
    }
    
    function renderGameFooter() {
      const footer = document.getElementById('gameFooter');
      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const isRoundEnd = gameState.roundEnded || gameState.state === 'roundEnd';
      const isGameOver = gameState.isGameOver;
      
      if (isHost && isRoundEnd) {
        footer.innerHTML = `
          <button class="modal-btn" onclick="${isGameOver ? 'newGame()' : 'nextRound()'}">
            ${isGameOver ? 'Nytt spel' : 'N√§sta runda'}
          </button>
          <button class="modal-btn secondary" onclick="hostEndGame()">Avsluta</button>
        `;
      } else {
        footer.innerHTML = `
          <button class="quit-btn" onclick="leaveRoom()">L√§mna spel</button>
        `;
      }
    }

    function renderTableau() {
      const container = document.getElementById('tableau');
      container.innerHTML = '';
      
      const lastPlayed = gameState.lastPlayedCards || [];

      for (const suit of SUITS) {
        const suitState = gameState.tableau[suit];
        const colorClass = SUIT_COLORS[suit];
        
        const column = document.createElement('div');
        column.className = 'suit-column';

        // √ñvre delen (visar bara det h√∂gsta kortet)
        const upperStack = document.createElement('div');
        upperStack.className = 'card-stack-upper';

        if (suitState && suitState.high > 7) {
          const highCard = document.createElement('div');
          const isKing = suitState.high === 13;
          // Markera som last-played om n√•got kort i √∂vre stacken (8 till high) √§r bland senast spelade
          const isLastPlayed = lastPlayed.some(id => {
            const [cardSuit, cardRank] = id.split('-');
            const rank = parseInt(cardRank);
            return cardSuit === suit && rank >= 8 && rank <= suitState.high;
          });
          highCard.className = `table-card ${colorClass}${isKing ? ' completed' : ''}${isLastPlayed ? ' last-played' : ''}`;
          highCard.innerHTML = `
            <span class="rank">${RANK_NAMES[suitState.high]}</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          upperStack.appendChild(highCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = suitState ? '8' : '';
          placeholder.style.visibility = suitState ? 'visible' : 'hidden';
          upperStack.appendChild(placeholder);
        }

        column.appendChild(upperStack);

        // Mitten (7:an)
        const sevenStack = document.createElement('div');
        sevenStack.className = 'card-stack-seven';

        if (suitState) {
          const sevenCard = document.createElement('div');
          const isLastPlayed = lastPlayed.includes(`${suit}-7`);
          sevenCard.className = `table-card ${colorClass} seven${isLastPlayed ? ' last-played' : ''}`;
          sevenCard.innerHTML = `
            <span class="rank">7</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          sevenStack.appendChild(sevenCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = '7';
          sevenStack.appendChild(placeholder);
        }

        column.appendChild(sevenStack);

        // Nedre delen (visar bara det l√§gsta kortet)
        const lowerStack = document.createElement('div');
        lowerStack.className = 'card-stack-lower';

        if (suitState && suitState.low < 7) {
          const lowCard = document.createElement('div');
          const isAce = suitState.low === 1;
          // Markera som last-played om n√•got kort i nedre stacken (low till 6) √§r bland senast spelade
          const isLastPlayed = lastPlayed.some(id => {
            const [cardSuit, cardRank] = id.split('-');
            const rank = parseInt(cardRank);
            return cardSuit === suit && rank >= suitState.low && rank <= 6;
          });
          lowCard.className = `table-card ${colorClass}${isAce ? ' completed' : ''}${isLastPlayed ? ' last-played' : ''}`;
          lowCard.innerHTML = `
            <span class="rank">${RANK_NAMES[suitState.low]}</span>
            <span class="suit">${SUIT_SYMBOLS[suit]}</span>
          `;
          lowerStack.appendChild(lowCard);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'card-placeholder';
          placeholder.textContent = suitState ? '6' : '';
          placeholder.style.visibility = suitState ? 'visible' : 'hidden';
          lowerStack.appendChild(placeholder);
        }

        column.appendChild(lowerStack);
        container.appendChild(column);
      }
    }

    function renderPlayers() {
      const container = document.getElementById('playersArea');
      container.innerHTML = '';

      // Sortera s√• att egen spelare visas f√∂rst
      const sortedPlayers = [...gameState.players].sort((a, b) => {
        if (a.isMe) return -1;
        if (b.isMe) return 1;
        return 0;
      });

      for (const player of sortedPlayers) {
        const section = document.createElement('div');
        section.className = `player-section ${player.isCurrent && !gameState.roundEnded ? 'current-player' : ''} ${player.isMe ? 'is-me' : ''} ${player.isWinner ? 'winner' : ''} ${player.isBot ? 'is-bot' : ''}`;

        const hasPlayable = gameState.playableCardIds?.length > 0;
        // I hj√§lpl√§ge: kan bara passa om inga spelbara kort
        // I standardl√§ge: kan alltid f√∂rs√∂ka passa (servern validerar)
        const canPass = player.isCurrent && player.isMe && !hasPlayable && !gameState.roundEnded;
        const showPassEnabled = gameState.helpMode ? canPass : (player.isCurrent && player.isMe && !gameState.roundEnded);

        section.innerHTML = `
          <div class="player-header">
            <div class="player-name">
              ${player.isBot ? 'ü§ñ ' : ''}${player.name}${player.isMe ? ' (du)' : ''}
              ${player.isDealer ? '<span class="dealer-badge">Gav</span>' : ''}
              ${player.isStarter ? '<span class="starter-badge">B√∂rjade</span>' : ''}
              ${player.isWinner ? '<span class="winner-badge">üèÜ Vinnare!</span>' : ''}
              ${player.isCurrent && !gameState.roundEnded ? '<span class="player-badge">Spelar</span>' : ''}
              ${player.hasAsken ? '<span class="asken-icon" title="Har asken">üì¶</span>' : ''}
            </div>
            <div class="player-stats">
              <span>${player.cardCount} kort</span>
              <span>‚Ä¢</span>
              <span>Po√§ng: ${player.score}</span>
            </div>
          </div>
          ${player.isMe && player.hand ? renderOwnHand(player) : renderHiddenHand(player.cardCount)}
          ${player.isMe && player.isCurrent && !gameState.roundEnded ? `
            <div class="action-buttons">
              <button class="action-btn play" onclick="playCards()" ${selectedCardIds.length === 0 || (gameState.helpMode && !validateSelectedCards()) ? 'disabled' : ''}>
                Spela ${selectedCardIds.length > 0 ? '(' + selectedCardIds.length + ' kort)' : ''}
              </button>
              <button class="action-btn pass" onclick="pass()" ${!showPassEnabled ? 'disabled' : ''}>
                Passa ${canPass ? '(ta asken)' : ''}
              </button>
            </div>
          ` : ''}
        `;

        container.appendChild(section);
      }
    }

    function renderOwnHand(player) {
      const hasPlayable = gameState.playableCardIds?.length > 0 && player.isCurrent && !gameState.roundEnded;
      const showHelpButton = hasPlayable && gameState.helpMode; // Visa bara om hj√§lp √§r p√•
      
      return `
        <div class="player-hand-container">
          <div class="player-hand">
            ${player.hand.map(card => {
              const isPlayable = gameState.playableCardIds?.includes(card.id) && player.isCurrent && !gameState.roundEnded;
              const isSelected = selectedCardIds.includes(card.id);
              const colorClass = SUIT_COLORS[card.suit];
              // Om hj√§lpl√§ge √§r av, markera inte kort som disabled
              const disabledClass = gameState.helpMode ? (isPlayable ? 'playable' : 'disabled') : 'playable';
              return `
                <div class="card ${colorClass} ${disabledClass} ${isSelected ? 'selected' : ''}"
                     onclick="toggleCard('${card.id}')">
                  <span class="card-rank">${RANK_NAMES[card.rank]}</span>
                  <span class="card-suit">${SUIT_SYMBOLS[card.suit]}</span>
                </div>
              `;
            }).join('')}
          </div>
          ${showHelpButton ? `
            <button class="select-all-btn" onclick="selectAllPlayable()" title="V√§lj alla spelbara kort">
              üí°
            </button>
          ` : ''}
        </div>
      `;
    }

    function renderHiddenHand(count) {
      return `
        <div class="hidden-hand">
          ${Array(count).fill('<div class="card-back"></div>').join('')}
        </div>
      `;
    }

    function renderInfo() {
      let titleText = `RUNDA ${gameState.roundNumber}`;
      
      if (gameState.roundEnded && gameState.roundWinners.length > 0) {
        if (gameState.roundWinners.length === 1) {
          titleText += ` SLUT ‚Ä¢ üèÜ ${gameState.roundWinners[0].name.toUpperCase()} VANN!`;
        } else {
          const names = gameState.roundWinners.map(w => w.name.toUpperCase());
          let winnerText;
          if (names.length === 2) {
            winnerText = names[0] + ' OCH ' + names[1];
          } else {
            const last = names.pop();
            winnerText = names.join(', ') + ' OCH ' + last;
          }
          titleText += ` SLUT ‚Ä¢ üèÜ ${winnerText} DELAR VINSTEN!`;
        }
      } else if (gameState.askenHolderId) {
        const holder = gameState.players.find(p => p.id === gameState.askenHolderId);
        titleText += ` ‚Ä¢ ${holder?.name?.toUpperCase() || 'OK√ÑND'} HAR ASKEN`;
      } else {
        titleText += ' ‚Ä¢ INGEN HAR ASKEN';
      }
      
      document.getElementById('tableauTitle').textContent = titleText;
    }

    function showResultModal() {
      const isGameOver = gameState.isGameOver;
      
      document.getElementById('modalTitle').textContent = isGameOver ? 'Spelet slut!' : `Runda ${gameState.roundNumber} slut!`;
      
      // Best√§m vinnare
      let winners;
      if (isGameOver) {
        // Spelvinnare = l√§gst TOTALPO√ÑNG
        const lowestTotal = Math.min(...gameState.players.map(p => p.score));
        winners = gameState.players.filter(p => p.score === lowestTotal);
      } else {
        // Rundvinnare = l√§gst po√§ng DENNA RUNDA (kommer fr√•n servern)
        winners = gameState.roundWinners;
      }
      
      if (winners.length === 1) {
        const winText = isGameOver ? 'vinner spelet!' : 'vinner rundan!';
        document.getElementById('modalWinner').textContent = `üèÜ ${winners[0].name} ${winText}`;
      } else {
        const names = winners.map(w => w.name);
        let winnerText;
        if (names.length === 2) {
          winnerText = names[0] + ' och ' + names[1];
        } else {
          const last = names.pop();
          winnerText = names.join(', ') + ' och ' + last;
        }
        const winText = isGameOver ? 'delar p√• segern!' : 'delar p√• vinsten!';
        document.getElementById('modalWinner').textContent = `üèÜ ${winnerText} ${winText}`;
      }

      // Sortera spelare f√∂r tabellen
      let playersToShow = [...gameState.players];
      if (isGameOver) {
        // Sortera efter totalpo√§ng (l√§gst f√∂rst = b√§st placering)
        playersToShow.sort((a, b) => a.score - b.score);
      }
      
      // Uppdatera tabellhuvud
      const thead = document.querySelector('#scoreTable thead tr');
      if (isGameOver) {
        thead.innerHTML = `
          <th>Plats</th>
          <th>Spelare</th>
          <th>Kort</th>
          <th>Po√§ng</th>
          <th>Asken</th>
          <th>Totalt</th>
        `;
      } else {
        thead.innerHTML = `
          <th>Spelare</th>
          <th>Kort</th>
          <th>Po√§ng</th>
          <th>Asken</th>
          <th>Totalt</th>
        `;
      }

      // Po√§ngtabell
      const tbody = document.getElementById('scoreBody');
      let currentPlace = 0;
      let lastScore = -1;
      
      tbody.innerHTML = playersToShow.map((p, index) => {
        // Hitta rundpo√§ng f√∂r denna spelare
        const roundScore = gameState.roundScores?.find(rs => rs.playerId === p.id);
        const cardPoints = roundScore ? roundScore.cardPoints : 0;
        const askenPoints = roundScore ? roundScore.askenPoints : 0;
        
        // Ber√§kna placering (hantera delade placeringar)
        if (p.score !== lastScore) {
          currentPlace = index + 1;
          lastScore = p.score;
        }
        
        const placeEmoji = currentPlace === 1 ? 'ü•á' : currentPlace === 2 ? 'ü•à' : currentPlace === 3 ? 'ü•â' : 'üíÄ';
        const placeText = `${placeEmoji} ${currentPlace}`;
        
        if (isGameOver) {
          return `
            <tr class="${currentPlace === 1 ? 'winner-row' : ''}">
              <td class="place-cell">${placeText}</td>
              <td>${p.name}${p.isMe ? ' (du)' : ''}</td>
              <td>${p.cardCount}</td>
              <td>${cardPoints}</td>
              <td class="${askenPoints > 0 ? 'asken-cell' : ''}">${askenPoints > 0 ? '+' + askenPoints : '‚Äî'}</td>
              <td class="total">${p.score}</td>
            </tr>
          `;
        } else {
          return `
            <tr>
              <td>${p.name}${p.isMe ? ' (du)' : ''}</td>
              <td>${p.cardCount}</td>
              <td>${cardPoints}</td>
              <td class="${askenPoints > 0 ? 'asken-cell' : ''}">${askenPoints > 0 ? '+' + askenPoints : '‚Äî'}</td>
              <td class="total">${p.score}</td>
            </tr>
          `;
        }
      }).join('');

      // Knappar
      const isHost = gameState.players.find(p => p.isMe)?.isHost;
      const buttonsHtml = isHost ? `
        <button class="modal-btn" onclick="${isGameOver ? 'newGame()' : 'nextRound()'}">
          ${isGameOver ? 'Nytt spel' : 'N√§sta runda'}
        </button>
        <button class="modal-btn secondary" onclick="hostEndGame()">Avsluta</button>
      ` : `
        <p class="not-host-msg">V√§ntar p√• att v√§rden ska forts√§tta...</p>
      `;
      document.getElementById('modalButtons').innerHTML = buttonsHtml;

      document.getElementById('modal').classList.add('visible');
    }

    // ============================================
    // INIT
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      connectSocket();
      
      // L√§s URL-parametrar (f√∂r inbjudningsl√§nkar)
      const urlParams = new URLSearchParams(window.location.search);
      const inviteName = urlParams.get('namn');
      const inviteRoom = urlParams.get('rum');
      
      if (inviteName) {
        document.getElementById('playerName').value = inviteName;
      }
      if (inviteRoom) {
        document.getElementById('roomCode').value = inviteRoom.toUpperCase();
        updateMainButton();
      }
      
      // Rensa URL-parametrar utan att ladda om sidan
      if (inviteName || inviteRoom) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Enter-tangent f√∂r att g√• med
      document.getElementById('roomCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') mainAction();
      });
      document.getElementById('playerName').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') mainAction();
      });
    });
    
    // ============================================
    // CHAT-FUNKTIONER
    // ============================================
    
    let chatMessages = [];
    let unreadCount = 0;
    let chatOpen = false;
    
    function openChat() {
      chatOpen = true;
      unreadCount = 0;
      updateChatBadge();
      document.getElementById('chatModal').classList.add('visible');
      document.getElementById('chatInput').focus();
      scrollChatToBottom();
    }
    
    function closeChat() {
      chatOpen = false;
      document.getElementById('chatModal').classList.remove('visible');
    }
    
    function handleChatKeypress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }
    
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !socket || !gameState) return;
      
      socket.emit('chatMessage', message);
      input.value = '';
    }
    
    function addChatMessage(data) {
      chatMessages.push(data);
      
      // Begr√§nsa till 100 meddelanden
      if (chatMessages.length > 100) {
        chatMessages.shift();
      }
      
      renderChatMessages();
      
      // Om chatten inte √§r √∂ppen, √∂ka ol√§st-r√§knaren
      if (!chatOpen) {
        unreadCount++;
        updateChatBadge();
      }
    }
    
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div class="chat-empty">Inga meddelanden √§n. S√§g hej!</div>';
        return;
      }
      
      container.innerHTML = chatMessages.map(msg => {
        if (msg.system) {
          return `<div class="chat-message system">${msg.text}</div>`;
        }
        
        const time = new Date(msg.timestamp).toLocaleTimeString('sv-SE', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        return `
          <div class="chat-message">
            <div class="chat-sender">${msg.sender}</div>
            <div class="chat-text">${escapeHtml(msg.text)}</div>
            <div class="chat-time">${time}</div>
          </div>
        `;
      }).join('');
      
      scrollChatToBottom();
    }
    
    function scrollChatToBottom() {
      const container = document.getElementById('chatMessages');
      container.scrollTop = container.scrollHeight;
    }
    
    function updateChatBadge() {
      const badge = document.getElementById('chatBadge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function clearChat() {
      chatMessages = [];
      unreadCount = 0;
      updateChatBadge();
      renderChatMessages();
    }
    
    // ============================================
    // DELNINGSFUNKTIONER
    // ============================================
    
    const SHARE_URL = 'https://asken.pistol.se';
    const SHARE_TITLE = 'Asken Online ‚Äì Spela klassiska kortspelet gratis';
    const SHARE_TEXT = 'Spela Asken online gratis med v√§nner! Det klassiska svenska kortspelet d√§r du t√§vlar om att bli av med alla kort f√∂rst.';
    
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    function shareToFacebook() {
      if (isMobile()) {
        // Facebook app med f√∂rkomponerat meddelande via fb://
        // Fallback till messenger om Facebook-appen inte kan dela direkt
        const fbAppUrl = `fb://share?quote=${encodeURIComponent(SHARE_TEXT)}&href=${encodeURIComponent(SHARE_URL)}`;
        const webUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SHARE_URL)}&quote=${encodeURIComponent(SHARE_TEXT)}`;
        
        // F√∂rs√∂k √∂ppna appen, fallback till webb
        window.location.href = fbAppUrl;
        setTimeout(() => {
          window.open(webUrl, '_blank');
        }, 500);
      } else {
        const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SHARE_URL)}&quote=${encodeURIComponent(SHARE_TEXT)}`;
        window.open(url, '_blank', 'width=600,height=400');
      }
    }
    
    function shareToTwitter() {
      const url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(SHARE_URL)}&text=${encodeURIComponent(SHARE_TEXT)}`;
      window.open(url, '_blank', 'width=600,height=400');
    }
    
    function shareToLinkedIn() {
      if (isMobile()) {
        // LinkedIn app deep link
        const linkedInAppUrl = `linkedin://shareArticle?mini=true&url=${encodeURIComponent(SHARE_URL)}&title=${encodeURIComponent(SHARE_TITLE)}&summary=${encodeURIComponent(SHARE_TEXT)}`;
        const webUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_URL)}`;
        
        // F√∂rs√∂k √∂ppna appen, fallback till webb
        window.location.href = linkedInAppUrl;
        setTimeout(() => {
          window.open(webUrl, '_blank');
        }, 500);
      } else {
        const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_URL)}`;
        window.open(url, '_blank', 'width=600,height=400');
      }
    }
    
    function shareToReddit() {
      const url = `https://www.reddit.com/submit?url=${encodeURIComponent(SHARE_URL)}&title=${encodeURIComponent(SHARE_TITLE)}`;
      window.open(url, '_blank', 'width=600,height=600');
    }
    
    function shareToWhatsApp() {
      const url = `https://wa.me/?text=${encodeURIComponent(SHARE_TEXT + ' ' + SHARE_URL)}`;
      window.open(url, '_blank');
    }
    
    function shareViaEmail() {
      const subject = encodeURIComponent(SHARE_TITLE);
      const body = encodeURIComponent(`${SHARE_TEXT}\n\nSpela h√§r: ${SHARE_URL}`);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
    
    function copyGameLink() {
      navigator.clipboard.writeText(SHARE_URL).then(() => {
        // Visa bekr√§ftelse
        const btn = event.currentTarget;
        const originalTitle = btn.title;
        btn.title = 'Kopierad!';
        btn.style.opacity = '1';
        setTimeout(() => {
          btn.title = originalTitle;
          btn.style.opacity = '';
        }, 2000);
      }).catch(err => {
        console.error('Kunde inte kopiera:', err);
      });
    }
  </script>
</body>
</html>
